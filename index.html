<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WEB MT - MTTTTTå¡ç‰Œ (å¸ƒå±€ä¼˜åŒ–ç‰ˆ)</title>
    <!-- 1. æ ·å¼åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. é«˜æ€§èƒ½è„šæœ¬åº“ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* å…¨å±€æ ·å¼ä¿®å¤ */
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #0f172a; touch-action: none; -webkit-user-select: none; user-select: none; }
        #root { width: 100%; height: 100%; }
        
        /* æ»šåŠ¨æ¡éšè—ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* åŠ¨ç”»å®šä¹‰ */
        .card-spring { transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s, border-color 0.2s; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-3%); } 50% { transform: translateY(3%); } }
        .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
        @keyframes fly-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-150px) scale(0.8) rotate(5deg); opacity: 0; } }
        .animate-fly-up { animation: fly-up 0.6s forwards; }
        @keyframes fly-down { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(150px) scale(0.8) rotate(-5deg); opacity: 0; } }
        .animate-fly-down { animation: fly-down 0.5s forwards; }
        
        /* ç‰¹æ•ˆå¡ç‰Œæ ·å¼ */
        .enhance-bonus { box-shadow: 0 0 10px #3b82f6; border-color: #60a5fa !important; } 
        .enhance-mult { box-shadow: 0 0 10px #ef4444; border-color: #f87171 !important; } 
        .enhance-wild { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%) !important; border-color: #a78bfa !important; color: black !important; }
        .enhance-glass { background: rgba(255,255,255,0.9) !important; opacity: 0.9; border-style: dashed !important; }
        .enhance-steel { background: #cbd5e1 !important; border-color: #94a3b8 !important; color: #475569 !important; }
        .enhance-gold { background: #fef9c3 !important; border-color: #eab308 !important; color: #854d0e !important; }
    </style>
</head>
<body class="antialiased text-slate-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 1. å›¾æ ‡ç»„ä»¶åº“ ---
        const IconWrapper = ({ children, className, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Heart: (p) => <IconWrapper {...p} fill={p.fill}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></IconWrapper>,
            Diamond: (p) => <IconWrapper {...p} fill={p.fill}><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0Z" /></IconWrapper>,
            Club: (p) => <IconWrapper {...p} fill={p.fill}><path d="M17.5 19c0-3.037-2-5.5-4.5-5.5-.447 0-.88.078-1.293.226C12.333 12.398 13 10.828 13 9a5 5 0 1 0-10 0c0 1.828.667 3.398 1.293 4.726-.413-.148-.846-.226-1.293-.226-2.5 0-4.5 2.463-4.5 5.5 0 2.15 1.157 4.013 3 4.815V23h13v-.185c1.843-.802 3-2.665 3-4.815Z" /></IconWrapper>,
            Spade: (p) => <IconWrapper {...p} fill={p.fill}><path d="M5 9c0 5.25 5 13 7 13 2 0 7-7.75 7-13 0-3.5-2-5.5-5-5.5-1.5 0-3 1.5-3.5 2.5C10 5 8.5 3.5 7 3.5 4 3.5 2 5.5 5 9Z" /><path d="M12 14v8" stroke="currentColor"/></IconWrapper>,
            Settings: (p) => <IconWrapper {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            BarChart: (p) => <IconWrapper {...p}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></IconWrapper>,
            Eye: (p) => <IconWrapper {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            Trash: (p) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconWrapper>,
            XCircle: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconWrapper>,
            ShoppingBag: (p) => <IconWrapper {...p}><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></IconWrapper>,
            Help: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>,
            Rotate: (p) => <IconWrapper {...p}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconWrapper>,
            Home: (p) => <IconWrapper {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>,
            Play: (p) => <IconWrapper {...p} fill={p.fill}><polygon points="5 3 19 12 5 21 5 3"/></IconWrapper>,
            Layers: (p) => <IconWrapper {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconWrapper>,
            X: (p) => <IconWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>,
            List: (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconWrapper>,
            Grid: (p) => <IconWrapper {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconWrapper>
        };

        // --- 2. æ•°æ®åº“é…ç½® ---
        const SUITS = [
            { type: 'spade', icon: Icons.Spade, color: 'text-slate-300', name: 'é»‘æ¡ƒ' },
            { type: 'heart', icon: Icons.Heart, color: 'text-red-500', name: 'çº¢æ¡ƒ' },
            { type: 'club', icon: Icons.Club, color: 'text-indigo-400', name: 'æ¢…èŠ±' },
            { type: 'diamond', icon: Icons.Diamond, color: 'text-orange-500', name: 'æ–¹ç‰‡' }
        ];
        const RANKS = [
            { label: '2', value: 2 }, { label: '3', value: 3 }, { label: '4', value: 4 }, { label: '5', value: 5 },
            { label: '6', value: 6 }, { label: '7', value: 7 }, { label: '8', value: 8 }, { label: '9', value: 9 },
            { label: '10', value: 10 }, { label: 'J', value: 10 }, { label: 'Q', value: 10 }, { label: 'K', value: 10 }, { label: 'A', value: 11 }
        ];
        const HAND_NAMES = {
            'High Card': 'é«˜ç‰Œ', 'Pair': 'å¯¹å­', 'Two Pair': 'ä¸¤å¯¹', 'Three of a Kind': 'ä¸‰æ¡',
            'Straight': 'é¡ºå­', 'Flush': 'åŒèŠ±', 'Full House': 'è‘«èŠ¦', 'Four of a Kind': 'å››æ¡',
            'Straight Flush': 'åŒèŠ±é¡º', 'Royal Flush': 'çš‡å®¶åŒèŠ±é¡º'
        };
        const DEFAULT_HAND_STATS = {
            'High Card': { level: 1, chips: 5, mult: 1, name: 'é«˜ç‰Œ' },
            'Pair': { level: 1, chips: 10, mult: 2, name: 'å¯¹å­' },
            'Two Pair': { level: 1, chips: 20, mult: 2, name: 'ä¸¤å¯¹' },
            'Three of a Kind': { level: 1, chips: 30, mult: 3, name: 'ä¸‰æ¡' },
            'Straight': { level: 1, chips: 30, mult: 4, name: 'é¡ºå­' },
            'Flush': { level: 1, chips: 35, mult: 4, name: 'åŒèŠ±' },
            'Full House': { level: 1, chips: 40, mult: 4, name: 'è‘«èŠ¦' },
            'Four of a Kind': { level: 1, chips: 60, mult: 7, name: 'å››æ¡' },
            'Straight Flush': { level: 1, chips: 100, mult: 8, name: 'åŒèŠ±é¡º' },
            'Royal Flush': { level: 1, chips: 200, mult: 8, name: 'çš‡å®¶åŒèŠ±é¡º' }
        };
        const DECKS = [
            { id: 'red', name: 'èµ¤çº¢å¡ç»„', desc: 'æ¯å›åˆ +1 å¼ƒç‰Œæ¬¡æ•°', color: 'from-red-900 to-red-700 border-red-500', stats: { hands: 4, discards: 4, money: 4, maxJokers: 5 } },
            { id: 'blue', name: 'è”šè“å¡ç»„', desc: 'æ¯å›åˆ +1 å‡ºç‰Œæ¬¡æ•°', color: 'from-blue-900 to-blue-700 border-blue-500', stats: { hands: 5, discards: 3, money: 4, maxJokers: 5 } },
            { id: 'yellow', name: 'é»„é‡‘å¡ç»„', desc: 'å¼€å±€æ‹¥æœ‰ $14', color: 'from-yellow-700 to-yellow-600 border-yellow-400', stats: { hands: 4, discards: 3, money: 14, maxJokers: 5 } },
            { id: 'black', name: 'æš—é»‘å¡ç»„', desc: '+1 MTæ§½ä½ï¼Œ-1 å‡ºç‰Œæ¬¡æ•°', color: 'from-slate-800 to-black border-slate-500', stats: { hands: 3, discards: 3, money: 4, maxJokers: 6 } },
            { id: 'green', name: 'ç¿ ç»¿å¡ç»„', desc: 'æ¯å›åˆç»“æŸæ—¶ï¼Œå‰©ä½™å‡ºç‰Œæ¬¡æ•°æä¾›é‡‘é’±', color: 'from-green-900 to-green-700 border-green-500', stats: { hands: 4, discards: 3, money: 4, maxJokers: 5 }, bonus: 'interest_hands' },
            { id: 'checkered', name: 'æ–¹æ ¼å¡ç»„', desc: 'ç‰Œç»„ä¸­åªæœ‰é»‘æ¡ƒå’Œçº¢æ¡ƒ', color: 'from-orange-900 to-red-900 border-orange-500', stats: { hands: 4, discards: 3, money: 4, maxJokers: 5 }, type: 'checkered' },
            { id: 'abandoned', name: 'åºŸå¼ƒå¡ç»„', desc: 'ç‰Œç»„ä¸­æ²¡æœ‰èŠ±ç‰Œ (J, Q, K)', color: 'from-gray-700 to-gray-900 border-gray-500', stats: { hands: 4, discards: 3, money: 4, maxJokers: 5 }, type: 'abandoned' },
            { id: 'plasma', name: 'ç­‰ç¦»å­å¡ç»„', desc: 'è®¡ç®—åˆ†æ•°æ—¶å¹³è¡¡ç­¹ç å’Œå€ç‡ (å–å¹³å‡å€¼)', color: 'from-pink-900 to-purple-900 border-pink-500', stats: { hands: 4, discards: 3, money: 4, maxJokers: 5 }, type: 'plasma' }
        ];
        const JOKERS_DB = [
            { id: 'j_joker', name: 'MT', desc: '+4 å€ç‡', cost: 4, type: 'add_mult', value: 4 },
            { id: 'j_greedy', name: 'è´ªå©ªMT', desc: 'æ‰“å‡ºæ–¹ç‰‡ç‰Œæ—¶ +4 å€ç‡', cost: 6, type: 'suit_mult', suit: 'diamond', value: 4 },
            { id: 'j_wrath', name: 'æš´æ€’MT', desc: 'æ‰“å‡ºé»‘æ¡ƒç‰Œæ—¶ +4 å€ç‡', cost: 6, type: 'suit_mult', suit: 'spade', value: 4 },
            { id: 'j_lust', name: 'è‰²æ¬²MT', desc: 'æ‰“å‡ºçº¢æ¡ƒç‰Œæ—¶ +4 å€ç‡', cost: 6, type: 'suit_mult', suit: 'heart', value: 4 },
            { id: 'j_glut', name: 'æš´é£ŸMT', desc: 'æ‰“å‡ºæ¢…èŠ±ç‰Œæ—¶ +4 å€ç‡', cost: 6, type: 'suit_mult', suit: 'club', value: 4 },
            { id: 'j_even', name: 'å¶æ•°MT', desc: 'æ‰“å‡ºå¶æ•°ç‰Œ(2,4,6,8,10) +4 å€ç‡', cost: 5, type: 'rank_mod_mult', mod: 0, value: 4 },
            { id: 'j_odd', name: 'å¥‡æ•°MT', desc: 'æ‰“å‡ºå¥‡æ•°ç‰Œ(A,3,5,7,9) +30 ç­¹ç ', cost: 5, type: 'rank_mod_chips', mod: 1, value: 30 },
            { id: 'j_scholar', name: 'å­¦è€…', desc: 'æ‰“å‡ºAæ—¶ +20 ç­¹ç  å’Œ +4 å€ç‡', cost: 8, type: 'card_specific', label: 'A', chips: 20, mult: 4 },
            { id: 'j_half', name: 'åŠä¸ªMT', desc: 'å¦‚æœæ‰“å‡ºçš„ç‰Œ<=3å¼ ï¼Œ+15 å€ç‡', cost: 10, type: 'count_less', count: 3, value: 15 },
            { id: 'j_banner', name: 'æ——å¸œ', desc: 'æ¯æ¬¡å‰©ä½™å¼ƒç‰Œæ¬¡æ•° +40 ç­¹ç ', cost: 8, type: 'discard_bonus', value: 40 }
        ];
        const PLANETS_DB = [
            { id: 'p_mercury', name: 'æ°´æ˜Ÿ', desc: 'å‡çº§ [å¯¹å­]', cost: 4, type: 'planet', target: 'Pair', chipsMod: 15, multMod: 1, color: 'bg-slate-500' },
            { id: 'p_venus', name: 'é‡‘æ˜Ÿ', desc: 'å‡çº§ [ä¸‰æ¡]', cost: 5, type: 'planet', target: 'Three of a Kind', chipsMod: 20, multMod: 2, color: 'bg-yellow-600' },
            { id: 'p_earth', name: 'åœ°çƒ', desc: 'å‡çº§ [è‘«èŠ¦]', cost: 6, type: 'planet', target: 'Full House', chipsMod: 25, multMod: 2, color: 'bg-green-600' },
            { id: 'p_mars', name: 'ç«æ˜Ÿ', desc: 'å‡çº§ [å››æ¡]', cost: 7, type: 'planet', target: 'Four of a Kind', chipsMod: 30, multMod: 3, color: 'bg-red-600' },
            { id: 'p_jupiter', name: 'æœ¨æ˜Ÿ', desc: 'å‡çº§ [åŒèŠ±]', cost: 6, type: 'planet', target: 'Flush', chipsMod: 15, multMod: 2, color: 'bg-orange-700' },
            { id: 'p_saturn', name: 'åœŸæ˜Ÿ', desc: 'å‡çº§ [é¡ºå­]', cost: 6, type: 'planet', target: 'Straight', chipsMod: 20, multMod: 2, color: 'bg-yellow-800' },
            { id: 'p_uranus', name: 'å¤©ç‹æ˜Ÿ', desc: 'å‡çº§ [ä¸¤å¯¹]', cost: 5, type: 'planet', target: 'Two Pair', chipsMod: 15, multMod: 1, color: 'bg-cyan-600' },
            { id: 'p_neptune', name: 'æµ·ç‹æ˜Ÿ', desc: 'å‡çº§ [åŒèŠ±é¡º]', cost: 8, type: 'planet', target: 'Straight Flush', chipsMod: 40, multMod: 4, color: 'bg-blue-700' },
            { id: 'p_pluto', name: 'å†¥ç‹æ˜Ÿ', desc: 'å‡çº§ [é«˜ç‰Œ]', cost: 3, type: 'planet', target: 'High Card', chipsMod: 10, multMod: 1, color: 'bg-gray-600' }
        ];
        const TAROTS_DB = [
            { id: 't_magician', name: 'é­”æœ¯å¸ˆ', desc: 'å°†è‡³å¤š2å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [ä¸‡èƒ½å¡]', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'wild', maxCards: 2, color: 'bg-purple-700' },
            { id: 't_empress', name: 'å¥³çš‡', desc: 'å°†è‡³å¤š2å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [å€ç‡å¡] (+4 å€ç‡)', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'mult', maxCards: 2, color: 'bg-pink-700' },
            { id: 't_hierophant', name: 'æ•™çš‡', desc: 'å°†è‡³å¤š2å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [ç­¹ç å¡] (+30 ç­¹ç )', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'bonus', maxCards: 2, color: 'bg-green-700' },
            { id: 't_lovers', name: 'æ‹äºº', desc: 'å°†è‡³å¤š1å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [ä¸‡èƒ½å¡]', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'wild', maxCards: 1, color: 'bg-rose-600' },
            { id: 't_chariot', name: 'æˆ˜è½¦', desc: 'å°†è‡³å¤š1å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [é’¢é“å¡]', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'steel', maxCards: 1, color: 'bg-slate-500' },
            { id: 't_hermit', name: 'éšè€…', desc: 'é‡‘é’±ç¿»å€ (æœ€å¤š +$20)', cost: 4, type: 'tarot', effect: 'money', amount: 20, color: 'bg-emerald-700' },
            { id: 't_devil', name: 'æ¶é­”', desc: 'å°†è‡³å¤š1å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [é»„é‡‘å¡]', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'gold', maxCards: 1, color: 'bg-yellow-700' }
        ];
        const SPECTRAL_DB = [
            { id: 's_immolate', name: 'çŒ®ç¥­', desc: 'éšæœºæ‘§æ¯5å¼ æ‰‹ç‰Œï¼Œè·å¾—$20', cost: 6, type: 'spectral', effect: 'destroy_hand_money', count: 5, amount: 20, color: 'bg-blue-900 border-2 border-blue-400' },
            { id: 's_cryptid', name: 'ç¥ç§˜ç”Ÿç‰©', desc: 'å¤åˆ¶2å¼ é€‰ä¸­çš„ç‰Œ', cost: 6, type: 'spectral', effect: 'copy', count: 2, color: 'bg-fuchsia-900 border-2 border-fuchsia-400' }
        ];
        const ENHANCED_CARDS_DB = [
            { id: 'ec_bonus_ace', name: 'ç­¹ç A', desc: 'ä¸€å¼ å¢å¼ºçš„é»‘æ¡ƒA (+30ç­¹ç )', cost: 6, type: 'playing_card', rank: 12, suit: 'spade', enhance: 'bonus' },
            { id: 'ec_mult_king', name: 'å€ç‡K', desc: 'ä¸€å¼ å¢å¼ºçš„çº¢æ¡ƒK (+4å€ç‡)', cost: 7, type: 'playing_card', rank: 11, suit: 'heart', enhance: 'mult' },
            { id: 'ec_wild_queen', name: 'ä¸‡èƒ½Q', desc: 'ä¸€å¼ å¢å¼ºçš„æ¢…èŠ±Q (ä¸‡èƒ½èŠ±è‰²)', cost: 8, type: 'playing_card', rank: 10, suit: 'club', enhance: 'wild' },
            { id: 'ec_steel_ten', name: 'é’¢é“10', desc: 'ä¸€å¼ å¢å¼ºçš„æ–¹ç‰‡10 (æ‰‹æŒx1.5å€)', cost: 6, type: 'playing_card', rank: 8, suit: 'diamond', enhance: 'steel' },
            { id: 'ec_gold_two', name: 'é»„é‡‘2', desc: 'ä¸€å¼ å¢å¼ºçš„é»‘æ¡ƒ2 (å›åˆç»“æŸ+$3)', cost: 5, type: 'playing_card', rank: 0, suit: 'spade', enhance: 'gold' }
        ];

        // --- 3. å·¥å…·å‡½æ•° ---
        const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash << 5) - hash + str.charCodeAt(i);
                hash = hash & hash;
            }
            return hash;
        };
        const shuffle = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; }
            return array;
        };
        const createDeck = (deckType) => {
            let deck = [];
            if (deckType === 'checkered') { ['spade', 'heart'].forEach(suit => { for(let i=0; i<2; i++) { RANKS.forEach((rank, index) => { deck.push({ id: generateUniqueId(), suit: suit, rankLabel: rank.label, value: rank.value, rankIndex: index, selected: false }); }); } }); return deck; }
            SUITS.forEach(suit => { RANKS.forEach((rank, index) => { if (deckType === 'abandoned' && (rank.label === 'J' || rank.label === 'Q' || rank.label === 'K')) return; deck.push({ id: generateUniqueId(), suit: suit.type, rankLabel: rank.label, value: rank.value, rankIndex: index, selected: false, suitName: suit.name }); }); });
            return deck;
        };
        const detectHandType = (cards) => {
            if (cards.length === 0) return null;
            const sorted = [...cards].sort((a, b) => a.rankIndex - b.rankIndex);
            const ranks = sorted.map(c => c.rankIndex);
            const nonWilds = cards.filter(c => c.enhance !== 'wild');
            let isFlush = false;
            if (cards.length === 5) { if (nonWilds.length === 0) isFlush = true; else { const firstSuit = nonWilds[0].suit; isFlush = nonWilds.every(c => c.suit === firstSuit); } }
            let isStraight = false;
            let uniqueRanks = [...new Set(ranks)];
            if (cards.length === 5) { if (uniqueRanks.length === 5 && uniqueRanks[4] - uniqueRanks[0] === 4) isStraight = true; if (!isStraight && uniqueRanks.length === 5 && JSON.stringify(uniqueRanks) === JSON.stringify([0, 1, 2, 3, 12])) isStraight = true; }
            const counts = {}; ranks.forEach(r => counts[r] = (counts[r] || 0) + 1);
            const countValues = Object.values(counts).sort((a, b) => b - a);
            let type = 'High Card';
            if (isFlush && isStraight) { const isRoyal = ranks[0] === 8 && ranks[4] === 12; type = isRoyal ? 'Royal Flush' : 'Straight Flush'; }
            else if (countValues[0] === 4) type = 'Four of a Kind';
            else if (countValues[0] === 3 && countValues[1] === 2) type = 'Full House';
            else if (isFlush) type = 'Flush';
            else if (isStraight) type = 'Straight';
            else if (countValues[0] === 3) type = 'Three of a Kind';
            else if (countValues[0] === 2 && countValues[1] === 2) type = 'Two Pair';
            else if (countValues[0] === 2) type = 'Pair';
            return type;
        };

        // --- 4. è¾…åŠ©ç»„ä»¶ (ä¿®æ”¹ç‰ˆï¼šæ¥æ”¶ className å±æ€§) ---
        const CapybaraAvatar = ({ className }) => (
            <div className={`relative animate-bounce-slow ${className || 'w-32 h-32 sm:w-40 sm:h-40 mb-6'}`}>
                <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-2xl filter saturate-110">
                    <circle cx="50" cy="70" r="20" fill="#a67c52" /><circle cx="150" cy="70" r="20" fill="#a67c52" /><rect x="40" y="50" width="120" height="110" rx="55" fill="#c49a6c" /><rect x="60" y="100" width="80" height="50" rx="25" fill="#d6b083" opacity="0.5" /><circle cx="70" cy="95" r="6" fill="#2d2d2d" /><circle cx="130" cy="95" r="6" fill="#2d2d2d" /><path d="M 90 115 L 110 115 L 100 125 Z" fill="#5c4033" /><path d="M 90 135 Q 100 145 110 135" stroke="#5c4033" strokeWidth="3" fill="none" strokeLinecap="round" />
                </svg>
            </div>
        );

        const Card = ({ card, onClick, mini = false, medium = false, animationState }) => {
            const suitConfig = SUITS.find(s => s.type === card.suit);
            const Icon = suitConfig.icon;
            let animClass = '';
            if (card.selected) {
                if (animationState === 'scoring') animClass = 'animate-fly-up';
                else if (animationState === 'discarding') animClass = 'animate-fly-down';
            }
            let enhanceClass = '';
            if (card.enhance === 'bonus') enhanceClass = 'enhance-bonus';
            if (card.enhance === 'mult') enhanceClass = 'enhance-mult';
            if (card.enhance === 'wild') enhanceClass = 'enhance-wild';
            if (card.enhance === 'glass') enhanceClass = 'enhance-glass';
            if (card.enhance === 'steel') enhanceClass = 'enhance-steel';
            if (card.enhance === 'gold') enhanceClass = 'enhance-gold';
            
            // ä¼˜åŒ–ï¼šç‰Œç»„é¢„è§ˆå°ºå¯¸ (medium) å’Œé»˜è®¤å°ºå¯¸
            let sizeClasses = 'w-16 h-24 text-lg sm:w-20 sm:h-32 sm:text-xl md:w-24 md:h-36 md:text-2xl'; 
            if (mini) sizeClasses = 'w-8 h-12 text-[10px]';
            else if (medium) sizeClasses = 'w-20 h-28 sm:w-24 sm:h-32 text-xl font-bold'; // 3. æ”¾å¤§ç‰Œç»„æŸ¥çœ‹å™¨ä¸­çš„ç‰Œ

            return (
                <div onClick={() => onClick && onClick(card)} className={`relative flex flex-col items-center justify-center bg-white border-2 rounded-lg shadow-md select-none cursor-pointer flex-shrink-0 card-spring ${card.selected ? '-translate-y-6 z-30 border-blue-400 shadow-xl ring-2 ring-blue-300' : 'border-gray-200 hover:-translate-y-2 hover:z-20 z-0'} ${sizeClasses} ${animClass} ${enhanceClass}`}>
                    <div className={`absolute top-1 left-1 flex flex-col items-center gap-0 leading-none ${suitConfig.color}`}>
                        <span className={`font-bold ${mini ? 'text-[8px]' : medium ? 'text-xs' : 'text-sm sm:text-lg'}`}>{card.rankLabel}</span>
                        <Icon className={`${mini ? 'w-2 h-2' : medium ? 'w-3 h-3' : 'w-3 h-3 sm:w-4 sm:h-4'}`} fill="currentColor" />
                    </div>
                    <Icon className={`${suitConfig.color} ${mini ? 'w-4 h-4' : medium ? 'w-6 h-6' : 'w-6 h-6 sm:w-10 sm:h-10'} opacity-90`} fill="currentColor" />
                    <div className={`absolute bottom-1 right-1 flex flex-col items-center gap-0 leading-none rotate-180 ${suitConfig.color}`}>
                        <span className={`font-bold ${mini ? 'text-[8px]' : medium ? 'text-xs' : 'text-sm sm:text-lg'}`}>{card.rankLabel}</span>
                        <Icon className={`${mini ? 'w-2 h-2' : medium ? 'w-3 h-3' : 'w-3 h-3 sm:w-4 sm:h-4'}`} fill="currentColor" />
                    </div>
                    {card.enhance && (<div className="absolute top-0 right-0 p-0.5"><span className="text-[8px] bg-slate-700 text-white px-1 rounded-bl">{card.enhance}</span></div>)}
                </div>
            );
        };

        const JokerCard = ({ joker, onSell }) => {
            let colorClass = 'bg-slate-800 border-yellow-500';
            if (joker.type === 'planet') colorClass = joker.color + ' border-white/30';
            if (joker.type === 'tarot') colorClass = joker.color + ' border-white/30';
            if (joker.type === 'spectral') colorClass = joker.color;
            if (joker.type === 'playing_card') colorClass = 'bg-white text-black border-gray-300';
            return (
                <div className={`relative flex flex-col items-center justify-center w-16 h-24 sm:w-20 sm:h-28 border-2 rounded-lg p-1 text-center shadow-lg group flex-shrink-0 ${colorClass}`}>
                    <div className={`font-bold text-xs mb-1 truncate w-full ${joker.type === 'playing_card' ? 'text-black' : 'text-white'}`}>{joker.name}</div>
                    <div className={`text-[9px] leading-tight break-words w-full h-full overflow-hidden flex items-center justify-center ${joker.type === 'playing_card' ? 'text-gray-600' : 'text-gray-200'}`}>{joker.desc}</div>
                    {onSell && (<button onClick={() => onSell(joker)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md z-10"><Icons.XCircle className="w-4 h-4 text-white"/></button>)}
                </div>
            );
        };

        // --- 1. ä¼˜åŒ–ï¼šè§„åˆ™å¼¹çª— (å¢åŠ è¯¦ç»†ç©æ³•) ---
        const RuleModal = ({ onClose }) => (
            <div className="absolute inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                <div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-3xl m-4 max-h-[85vh] flex flex-col shadow-2xl animate-in zoom-in-95">
                    <div className="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800/90 backdrop-blur sticky top-0 z-10">
                        <h2 className="text-2xl font-bold text-yellow-400 flex items-center gap-2"><Icons.Help className="w-6 h-6"/> æ¸¸æˆæŒ‡å—</h2>
                        <button onClick={onClose}><Icons.X className="w-6 h-6 text-slate-400 hover:text-white"/></button>
                    </div>
                    <div className="p-6 overflow-y-auto custom-scrollbar space-y-6 text-slate-300 text-sm sm:text-base leading-relaxed">
                        <section>
                            <h3 className="text-xl font-bold text-white mb-2">ğŸ¯ æ ¸å¿ƒç›®æ ‡</h3>
                            <p>è¿™æ˜¯ä¸€æ¬¾æ‰‘å…‹ Roguelike æ¸¸æˆã€‚ä½ éœ€è¦é€šè¿‡æ‰“å‡ºæ‰‹ç‰Œèµšå–ç­¹ç ï¼Œå‡»è´¥æ¯å…³çš„<span className="text-red-400 font-bold">ç›®æ ‡åˆ†æ•° (ç›²æ³¨)</span>ã€‚</p>
                        </section>
                        <section className="bg-slate-900/50 p-4 rounded-lg border border-slate-700/50">
                            <h3 className="text-xl font-bold text-white mb-2">ğŸ§® è®¡åˆ†å…¬å¼ (æ ¸å¿ƒ!)</h3>
                            <div className="text-center font-mono text-lg bg-slate-800 p-2 rounded mb-2">
                                <span className="text-blue-400 font-bold">ç­¹ç  (Chips)</span> Ã— <span className="text-red-400 font-bold">å€ç‡ (Mult)</span> = å¾—åˆ†
                            </div>
                            <ul className="list-disc pl-5 space-y-1">
                                <li><b>ç­¹ç æ¥æºï¼š</b>æ‰“å‡ºçš„å¡ç‰Œç‚¹æ•° (2-10, JQK=10, A=11) + ç‰Œå‹åŸºç¡€å€¼ + è“è‰²MTç‰ŒåŠ æˆã€‚</li>
                                <li><b>å€ç‡æ¥æºï¼š</b>ç‰Œå‹åŸºç¡€å€ç‡ + çº¢è‰²MTç‰ŒåŠ æˆ (è¿™æ˜¯çˆ†å‘çš„å…³é”®)ã€‚</li>
                            </ul>
                        </section>
                        <section>
                            <h3 className="text-xl font-bold text-white mb-2">ğŸƒ ç‰Œå‹ä¸€è§ˆ (ä»å¤§åˆ°å°)</h3>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                                <div className="p-2 bg-slate-700 rounded"><span className="text-yellow-300 font-bold">çš‡å®¶åŒèŠ±é¡º</span> (åŒèŠ±è‰² 10,J,Q,K,A)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-blue-300 font-bold">åŒèŠ±é¡º</span> (åŒèŠ±è‰²é¡ºå­)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-purple-300 font-bold">å››æ¡</span> (4å¼ ä¸€æ ·)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-orange-300 font-bold">è‘«èŠ¦</span> (3å¼ ä¸€æ ·+2å¼ ä¸€æ ·)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-green-300 font-bold">åŒèŠ±</span> (5å¼ åŒèŠ±è‰²)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-cyan-300 font-bold">é¡ºå­</span> (5å¼ ç‚¹æ•°è¿ç»­)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-white font-bold">ä¸‰æ¡</span> (3å¼ ä¸€æ ·)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-white font-bold">ä¸¤å¯¹</span> (2å¯¹ç‰Œ)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-gray-300 font-bold">å¯¹å­</span> (2å¼ ä¸€æ ·)</div>
                                <div className="p-2 bg-slate-700 rounded"><span className="text-gray-500 font-bold">é«˜ç‰Œ</span> (æ— ç‰Œå‹)</div>
                            </div>
                        </section>
                        <section>
                            <h3 className="text-xl font-bold text-white mb-2">ğŸ›ï¸ é“å…·ç³»ç»Ÿ</h3>
                            <ul className="space-y-2">
                                <li><span className="text-yellow-400 font-bold">MTç‰Œ (Jokers):</span> æä¾›è¢«åŠ¨åŠ æˆï¼Œæ˜¯æ¸¸æˆæ ¸å¿ƒã€‚ä¾‹å¦‚â€œ+4å€ç‡â€æˆ–â€œæ‰“å‡ºçº¢æ¡ƒ+ç­¹ç â€ã€‚</li>
                                <li><span className="text-blue-400 font-bold">æ˜Ÿçƒç‰Œ:</span> æ°¸ä¹…å‡çº§æŸç§ç‰Œå‹çš„åŸºç¡€åˆ†æ•°ã€‚</li>
                                <li><span className="text-purple-400 font-bold">å¡”ç½—ç‰Œ:</span> å¢å¼ºå•å¼ å¡ç‰Œï¼ˆå¦‚å˜ä¸‡èƒ½ç‰Œã€å˜é»„é‡‘ç‰Œï¼‰ã€‚</li>
                            </ul>
                        </section>
                    </div>
                    <div className="p-4 border-t border-slate-700 bg-slate-800 rounded-b-xl">
                        <button onClick={onClose} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold text-lg shadow-lg">æˆ‘æ˜ç™½äº†ï¼Œå¼€å§‹æˆ˜æ–—ï¼</button>
                    </div>
                </div>
            </div>
        );

        // --- æ–°å¢ï¼šå•†å“ç‰Œå›¾é‰´ (MTç‰Œ) ---
        const ProductCompendiumModal = ({ onClose }) => {
            const Section = ({ title, data }) => (
                <div className="mb-8">
                    <h3 className="text-xl font-bold text-white mb-4 border-l-4 border-blue-500 pl-3">{title}</h3>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        {data.map(item => (
                            <div key={item.id} className="flex flex-col items-center p-2 bg-slate-700/30 rounded-xl border border-slate-600/50 hover:bg-slate-700/50 transition-colors">
                                <JokerCard joker={item} />
                                <div className="mt-2 text-center w-full">
                                    <div className="text-[10px] text-slate-400 mb-1 h-8 overflow-hidden">{item.desc}</div>
                                    <div className="font-bold text-yellow-400 bg-slate-900 px-2 py-0.5 rounded text-xs border border-yellow-500/30 inline-block">${item.cost}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="absolute inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-5xl max-h-[90vh] flex flex-col shadow-2xl animate-in zoom-in-95">
                        <div className="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800/90 backdrop-blur sticky top-0 z-10">
                            <h2 className="text-2xl font-bold text-yellow-400 flex items-center gap-2"><Icons.Layers className="w-6 h-6"/> å…¨å•†å“å›¾é‰´</h2>
                            <button onClick={onClose}><Icons.X className="w-6 h-6 text-slate-400 hover:text-white"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            <Section title="MTç‰Œ (Jokers)" data={JOKERS_DB} />
                            <Section title="æ˜Ÿçƒç‰Œ (Planets)" data={PLANETS_DB} />
                            <Section title="å¡”ç½—ç‰Œ (Tarots)" data={TAROTS_DB} />
                            <Section title="å¹»çµç‰Œ (Spectrals)" data={SPECTRAL_DB} />
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. ä¼˜åŒ–ï¼šç‰Œç»„é¢„è§ˆ (åˆ†ç»„æ’åº + æ”¾å¤§æ˜¾ç¤º) ---
        const DeckViewModal = ({ deck, onClose }) => {
            const sortedDeck = useMemo(() => {
                const groups = { spade: [], heart: [], club: [], diamond: [] };
                // 1. åˆ†ç»„
                deck.forEach(c => { if(groups[c.suit]) groups[c.suit].push(c); });
                // 2. æ’åº (ç‚¹æ•°ä»å¤§åˆ°å°)
                Object.keys(groups).forEach(key => {
                    groups[key].sort((a, b) => b.rankIndex - a.rankIndex);
                });
                return groups;
            }, [deck]);

            return (
                <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-5xl max-h-[90vh] flex flex-col shadow-2xl animate-in zoom-in-95">
                        <div className="flex justify-between items-center p-4 border-b border-slate-700">
                            <h2 className="text-xl font-bold text-blue-400 flex items-center gap-2"><Icons.Eye className="w-6 h-6"/> å‰©ä½™ç‰Œç»„ ({deck.length})</h2>
                            <button onClick={onClose}><Icons.X className="w-6 h-6 text-slate-400 hover:text-white"/></button>
                        </div>
                        <div className="overflow-y-auto p-4 custom-scrollbar space-y-6">
                            {['spade', 'heart', 'club', 'diamond'].map(suit => (
                                <div key={suit} className="flex gap-4 items-start border-b border-slate-700/50 pb-4 last:border-0">
                                    <div className="w-10 pt-2 flex flex-col items-center">
                                        {suit === 'spade' && <Icons.Spade className="w-8 h-8 text-slate-300" fill="currentColor"/>}
                                        {suit === 'heart' && <Icons.Heart className="w-8 h-8 text-red-500" fill="currentColor"/>}
                                        {suit === 'club' && <Icons.Club className="w-8 h-8 text-indigo-400" fill="currentColor"/>}
                                        {suit === 'diamond' && <Icons.Diamond className="w-8 h-8 text-orange-500" fill="currentColor"/>}
                                    </div>
                                    <div className="flex-1 flex flex-wrap gap-2">
                                        {sortedDeck[suit].length > 0 ? 
                                            sortedDeck[suit].map(c => <Card key={c.id} card={c} medium={true} />) : 
                                            <span className="text-slate-600 italic py-2">æ— æ­¤èŠ±è‰²</span>
                                        }
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const RunInfoModal = ({ handStats, onClose }) => (
            <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-xl max-h-[85vh] flex flex-col shadow-2xl animate-in zoom-in-95"><div className="flex justify-between items-center p-4 border-b border-slate-700"><h2 className="text-xl font-bold text-red-400">ç‰Œå‹ç­‰çº§</h2><button onClick={onClose}><Icons.X className="w-6 h-6 text-slate-400 hover:text-white"/></button></div><div className="overflow-y-auto p-4 custom-scrollbar"><div className="grid gap-2">{Object.values(handStats).map((stat, idx) => (<div key={idx} className="flex justify-between items-center bg-slate-900/50 p-3 rounded border border-slate-700/50"><span className="text-white font-bold">{stat.name} <span className="text-xs bg-blue-600 px-1 rounded ml-1">Lv.{stat.level}</span></span><span className="font-mono"><span className="text-blue-300">{stat.chips}</span> X <span className="text-red-400">{stat.mult}</span></span></div>))}</div></div></div></div>
        );

        const SettingsModal = ({ onClose, onRestart, onMenu, onShowRules, onShowJokerCompendium }) => (
            <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                <div className="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-md p-6 shadow-2xl flex flex-col gap-4 animate-in zoom-in-95">
                    <h2 className="text-2xl font-bold text-white text-center mb-2">è®¾ç½®</h2>
                    <button onClick={() => { onShowRules(); }} className="bg-slate-700 hover:bg-slate-600 text-white p-3 rounded-lg font-bold flex items-center justify-center gap-2 border border-slate-600"><Icons.Help className="w-5 h-5"/> æŸ¥çœ‹è§„åˆ™</button>
                    {/* ä¿®æ”¹æŒ‰é’®ï¼šæŸ¥çœ‹æ‰€æœ‰å•†å“ç‰Œ */}
                    <button onClick={() => { onShowJokerCompendium(); }} className="bg-slate-700 hover:bg-slate-600 text-white p-3 rounded-lg font-bold flex items-center justify-center gap-2 border border-slate-600"><Icons.Grid className="w-5 h-5"/> æŸ¥çœ‹æ‰€æœ‰å•†å“ç‰Œ</button>
                    <button onClick={() => { onRestart(); onClose(); }} className="bg-orange-600 hover:bg-orange-500 text-white p-3 rounded-lg font-bold flex items-center justify-center gap-2"><Icons.Rotate className="w-5 h-5"/> é‡å¼€æœ¬å±€</button>
                    <button onClick={() => { onMenu(); onClose(); }} className="bg-red-600 hover:bg-red-500 text-white p-3 rounded-lg font-bold flex items-center justify-center gap-2"><Icons.Home className="w-5 h-5"/> è¿”å›ä¸»èœå•</button>
                    <button onClick={onClose} className="mt-2 text-slate-400 hover:text-white text-sm">å…³é—­</button>
                </div>
            </div>
        );

        // --- 5. ä¼˜åŒ–ï¼šç™»å½•é¡µ (é’ˆå¯¹æ‰‹æœºæ¨ªå±å¤§å¹…ç¼©å°å°ºå¯¸) ---
        const LoginScreen = ({ onLogin }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (simpleHash(input) === 73669169) onLogin();
                else { setError('å¯†é’¥é”™è¯¯'); setTimeout(() => setError(''), 2000); }
            };
            return (
                <div className="flex flex-col items-center justify-center h-full bg-slate-900 text-white p-4">
                    {/* å¤´åƒç¼©å°åˆ° w-20 (80px) */}
                    <CapybaraAvatar className="w-20 h-20 sm:w-28 sm:h-28 mb-3" />
                    
                    {/* æ ‡é¢˜ç¼©å° */}
                    <h1 className="text-2xl font-black mb-4 tracking-widest text-center">MTTTTTå¡ç‰Œ ç³»ç»Ÿ</h1>
                    
                    <form onSubmit={handleSubmit} className="w-full max-w-xs flex flex-col gap-3">
                        {/* è¾“å…¥æ¡†å’ŒæŒ‰é’®é«˜åº¦å‹ç¼© */}
                        <input 
                            type="password" 
                            value={input} 
                            onChange={(e) => setInput(e.target.value)} 
                            placeholder="è¯·è¾“å…¥ç³»ç»Ÿå¯†é’¥" 
                            className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-center text-lg focus:outline-none focus:border-blue-500 transition-all shadow-inner" 
                            autoFocus 
                        />
                        <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform">éªŒè¯èº«ä»½</button>
                    </form>
                    
                    {error && <p className="mt-2 text-red-500 text-sm font-bold animate-pulse">{error}</p>}
                </div>
            );
        };

        // --- ä¸»æ¸¸æˆåº”ç”¨ ---
        function App() {
            const [gameState, setGameState] = useState('login'); 
            const [showSettings, setShowSettings] = useState(false); 
            const [showRunInfo, setShowRunInfo] = useState(false);
            const [showDeckView, setShowDeckView] = useState(false);
            const [showRuleModal, setShowRuleModal] = useState(false);
            const [showJokerCompendium, setShowJokerCompendium] = useState(false); 
            const [actionState, setActionState] = useState('idle');
            const [handStats, setHandStats] = useState(DEFAULT_HAND_STATS); 
            const [selectedDeck, setSelectedDeck] = useState(null); 
            const [deck, setDeck] = useState([]);
            const [hand, setHand] = useState([]);
            const [round, setRound] = useState(1);
            const [targetScore, setTargetScore] = useState(300);
            const [currentScore, setCurrentScore] = useState(0);
            const [money, setMoney] = useState(4);
            const [handsLeft, setHandsLeft] = useState(4);
            const [discardsLeft, setDiscardsLeft] = useState(3);
            const [maxJokers, setMaxJokers] = useState(5); 
            const [myJokers, setMyJokers] = useState([]);
            const [consumables, setConsumables] = useState([]); 
            const [shopJokers, setShopJokers] = useState([]);
            const [scoreBreakdown, setScoreBreakdown] = useState(null);
            const [message, setMessage] = useState('');
            const maxConsumables = 2;

            const launchGame = (chosenDeck) => {
                setSelectedDeck(chosenDeck);
                setDeck(shuffle(createDeck(chosenDeck.type))); 
                setHandStats(JSON.parse(JSON.stringify(DEFAULT_HAND_STATS))); // Deep copy
                setHand([]);
                setRound(1);
                setTargetScore(600);
                setCurrentScore(0);
                setMoney(chosenDeck.stats.money);
                setHandsLeft(chosenDeck.stats.hands);
                setDiscardsLeft(chosenDeck.stats.discards);
                setMaxJokers(chosenDeck.stats.maxJokers);
                setMyJokers([]);
                setConsumables([]);
                setGameState('playing');
                setActionState('idle');
            };

            const restartGame = () => { if (selectedDeck) launchGame(selectedDeck); else setGameState('menu'); };

            // è‡ªåŠ¨è¡¥ç‰Œ - ä¿®æ­£ä¸º10å¼ 
            useEffect(() => {
                if (gameState === 'playing' && hand.length < 10 && deck.length > 0) {
                    const needed = 10 - hand.length;
                    const newCards = deck.slice(0, needed);
                    setHand(prev => [...prev, ...newCards]);
                    setDeck(prev => prev.slice(needed));
                }
            }, [gameState, hand.length, deck.length]);

            const selectedCards = useMemo(() => hand.filter(c => c.selected), [hand]);
            const currentHandType = useMemo(() => detectHandType(selectedCards), [selectedCards]);
            const currentHandInfo = useMemo(() => {
                if (!currentHandType) return { name: 'è¯·é€‰ç‰Œ', level: 0, chips: 0, mult: 0 };
                return { type: currentHandType, ...handStats[currentHandType] }; 
            }, [currentHandType, handStats]);

            const calculateScore = useCallback((cards, jokers, baseInfo) => {
                if (!baseInfo || baseInfo.chips === undefined) return { totalChips: 0, totalMult: 0, totalScore: 0, triggers: [] };
                let chips = baseInfo.chips;
                let mult = baseInfo.mult;
                let cardChips = 0;
                cards.forEach(c => {
                    let val = c.value;
                    if (c.enhance === 'bonus') val += 30; 
                    cardChips += val;
                    if (c.enhance === 'mult') mult += 4; if (c.enhance === 'glass') mult *= 2; 
                });
                let jokerLog = [];
                jokers.forEach(j => {
                    let triggered = false;
                    if (j.type === 'add_mult') { mult += j.value; triggered = true; } 
                    else if (j.type === 'suit_mult') { if (cards.some(c => c.suit === j.suit || c.enhance === 'wild')) { mult += j.value; triggered = true; } } 
                    else if (j.type === 'rank_mod_mult') { if (cards.some(c => c.value % 2 === j.mod)) { mult += j.value; triggered = true; } }
                    else if (j.type === 'rank_mod_chips') { if (cards.some(c => c.value % 2 === j.mod)) { cardChips += j.value; triggered = true; } }
                    else if (j.type === 'card_specific') { if (cards.some(c => c.rankLabel === j.label)) { chips += j.chips; mult += j.mult; triggered = true; } }
                    else if (j.type === 'count_less') { if (cards.length <= j.count) { mult += j.value; triggered = true; } }
                    else if (j.type === 'discard_bonus') { chips += (discardsLeft * j.value); triggered = true; }
                    if (triggered) jokerLog.push(j.name);
                });
                const steelCards = hand.filter(c => !c.selected && c.enhance === 'steel');
                if (steelCards.length > 0) { steelCards.forEach(() => { mult *= 1.5; }); jokerLog.push(`é’¢é“å¡x${steelCards.length}`); }
                return { totalChips: chips + cardChips, totalMult: mult, totalScore: Math.floor((chips + cardChips) * mult), triggers: jokerLog };
            }, [discardsLeft, hand, selectedDeck]);

            const previewData = useMemo(() => calculateScore(selectedCards, myJokers, currentHandInfo), [selectedCards, myJokers, currentHandInfo, calculateScore]);

            const playHand = () => {
                if (selectedCards.length === 0 || handsLeft <= 0) return;
                setActionState('scoring');
                setGameState('scoring');
                const result = previewData;
                setScoreBreakdown({ name: currentHandInfo.name, baseChips: currentHandInfo.chips, cardChips: result.totalChips - currentHandInfo.chips, baseMult: currentHandInfo.mult, finalMult: result.totalMult, total: result.totalScore, jokersTriggered: result.triggers });
                setTimeout(() => {
                    const newScore = currentScore + result.totalScore;
                    setCurrentScore(newScore);
                    setHandsLeft(prev => prev - 1);
                    setHand(prev => prev.filter(c => !c.selected));
                    setScoreBreakdown(null);
                    setActionState('idle'); 
                    if (newScore >= targetScore) { setMessage("ç›®æ ‡è¾¾æˆï¼"); setTimeout(winRound, 1000); } 
                    else if (handsLeft - 1 === 0) { setGameState('gameover'); } 
                    else { setGameState('playing'); }
                }, 2000);
            };

            const discardHand = () => {
                if (selectedCards.length === 0 || discardsLeft <= 0 || actionState !== 'idle') return;
                setActionState('discarding');
                setTimeout(() => { setHand(prev => prev.filter(c => !c.selected)); setDiscardsLeft(prev => prev - 1); setActionState('idle'); }, 500); 
            };

            const winRound = () => {
                const goldCards = hand.filter(c => c.enhance === 'gold');
                const goldMoney = goldCards.length * 3;
                let interestCap = 5;
                if (selectedDeck.id === 'green') interestCap = 0; 
                const interest = Math.min(Math.floor(money / 5), interestCap); 
                let reward = 3 + handsLeft + interest + goldMoney;
                if (selectedDeck.id === 'green') reward += handsLeft * 1; 
                setMoney(prev => prev + reward);
                
                // ç”Ÿæˆå•†åº—ç‰©å“
                const shopItems = [];
                for(let i=0; i<5; i++) { 
                    const rand = Math.random();
                    let pool;
                    if (rand < 0.15) pool = PLANETS_DB; else if (rand < 0.3) pool = TAROTS_DB; else if (rand < 0.35) pool = SPECTRAL_DB; else if (rand < 0.45) pool = ENHANCED_CARDS_DB; else pool = JOKERS_DB;
                    shopItems.push({ ...pool[Math.floor(Math.random() * pool.length)], uid: generateUniqueId() });
                }
                setShopJokers(shopItems);
                setGameState('shop');
                setMessage(`å›åˆèƒœåˆ©ï¼è·å¾— $${reward}`);
            };

            const nextRound = () => {
                setRound(r => r + 1);
                setTargetScore(Math.floor(targetScore * 1.8)); 
                setCurrentScore(0);
                setHandsLeft(selectedDeck.stats.hands);
                setDiscardsLeft(selectedDeck.stats.discards);
                setDeck(shuffle(createDeck(selectedDeck.type)));
                setHand([]);
                setGameState('playing');
                setMessage('');
            };

            const buyItem = (item, idx) => {
                if (money >= item.cost) {
                    if (item.type === 'planet' || item.type === 'tarot' || item.type === 'spectral') {
                        if (consumables.length < maxConsumables) {
                            setMoney(m => m - item.cost);
                            setConsumables([...consumables, item]);
                            const newShop = [...shopJokers]; newShop.splice(idx, 1); setShopJokers(newShop);
                        } else setMessage("æ¶ˆè€—å“æ§½ä½å·²æ»¡ï¼");
                    } else if (item.type === 'playing_card') {
                        setMoney(m => m - item.cost);
                        setDeck(prev => [...prev, { id: generateUniqueId(), suit: item.suit, rankLabel: RANKS.find(r => r.value === (item.rank === 12 ? 11 : item.rank) || r.label === (item.rank === 12 ? 'A' : '')).label, value: item.rank === 12 ? 11 : item.rank, rankIndex: item.rank, selected: false, enhance: item.enhance }]);
                        const newShop = [...shopJokers]; newShop.splice(idx, 1); setShopJokers(newShop);
                        setMessage("å¡ç‰Œå·²åŠ å…¥ç‰Œç»„");
                    } else {
                        if (myJokers.length < maxJokers) {
                             setMoney(m => m - item.cost);
                             setMyJokers([...myJokers, { ...item, uid: generateUniqueId() }]);
                             const newShop = [...shopJokers]; newShop.splice(idx, 1); setShopJokers(newShop);
                        } else setMessage("MTæ§½ä½å·²æ»¡ï¼");
                    }
                }
            };
            
            const useConsumable = (item) => {
                if (item.type === 'planet') {
                    setHandStats(prev => {
                        const target = item.target;
                        const current = prev[target];
                        return { ...prev, [target]: { ...current, level: current.level + 1, chips: current.chips + item.chipsMod, mult: current.mult + item.multMod } };
                    });
                    setMessage(`å‡çº§æˆåŠŸï¼${item.desc}`);
                } else if (item.effect === 'money') {
                    setMoney(m => Math.min(m + item.amount, m * 2)); 
                    setMessage("è·å¾—é‡‘é’±ï¼");
                } else if (item.effect === 'enhance') {
                    if (selectedCards.length === 0 || selectedCards.length > item.maxCards) { setMessage(`è¯·é€‰æ‹© ${item.maxCards} å¼ ç‰Œä½¿ç”¨`); return; }
                    setHand(prev => prev.map(c => c.selected ? { ...c, enhance: item.enhanceType, selected: false } : c));
                    setMessage("å¡ç‰Œå·²å¢å¼ºï¼");
                } else if (item.effect === 'destroy_hand_money') {
                    if (hand.length < item.count) { setMessage("æ‰‹ç‰Œä¸è¶³ï¼"); return; }
                    let indicesToRemove = [];
                    while(indicesToRemove.length < item.count) {
                        let r = Math.floor(Math.random() * hand.length);
                        if(!indicesToRemove.includes(r)) indicesToRemove.push(r);
                    }
                    setHand(prev => prev.filter((_, i) => !indicesToRemove.includes(i)));
                    setMoney(m => m + item.amount);
                    setMessage("çŒ®ç¥­æˆåŠŸï¼");
                } else if (item.effect === 'copy') {
                    if (selectedCards.length === 0 || selectedCards.length > 2) { setMessage(`è¯·é€‰æ‹©æœ€å¤š2å¼ ç‰Œå¤åˆ¶`); return; }
                    const newCards = selectedCards.map(c => ({...c, id: generateUniqueId(), selected: false}));
                    setHand(prev => [...prev, ...newCards]);
                    setMessage("å¤åˆ¶æˆåŠŸï¼");
                }
                setConsumables(prev => prev.filter(c => c.uid !== item.uid));
            };

            const sellItem = (item) => {
                setMoney(m => m + Math.floor(item.cost / 2));
                if (myJokers.some(j => j.uid === item.uid)) setMyJokers(prev => prev.filter(j => j.uid !== item.uid));
                else setConsumables(prev => prev.filter(c => c.uid !== item.uid));
            };

            const toggleSelect = (card) => {
                if (actionState !== 'idle') return;
                // Optional: Enforce max selection (5 cards)
                if (!card.selected && hand.filter(c => c.selected).length >= 5) return;
                setHand(hand.map(c => c.id === card.id ? { ...c, selected: !c.selected } : c));
            };

            // ç™»å½•ç•Œé¢ (å¯†ç : MT888 -> 73669169)
            if (gameState === 'login') return <LoginScreen onLogin={() => setGameState('menu')} />;

            // ä¸»èœå•
            if (gameState === 'menu') return (
                <div className="flex flex-col items-center justify-center h-full bg-slate-900 p-6 text-center">
                    <CapybaraAvatar />
                    <h1 className="text-4xl font-black text-white mb-12">ä¸»èœå•</h1>
                    <button onClick={() => setGameState('deck_select')} className="bg-blue-600 text-white px-12 py-4 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-all flex items-center gap-2"><Icons.Play className="w-6 h-6" fill="currentColor"/> å¼€å§‹æ–°å±€</button>
                </div>
            );

            // é€‰ç»„
            if (gameState === 'deck_select') return (
                <div className="flex flex-col items-center h-full bg-slate-900 p-6 overflow-y-auto hide-scrollbar">
                    <h1 className="text-4xl font-black text-white mt-4 mb-8">é€‰æ‹©ä½ çš„åˆå§‹å¡ç»„</h1>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-6xl pb-10">
                        {DECKS.map(d => (
                            <div key={d.id} onClick={() => launchGame(d)} className={`cursor-pointer group relative bg-gradient-to-br ${d.color} p-8 rounded-[2rem] border-2 border-white/10 shadow-2xl hover:scale-[1.02] transition-all active:scale-95`}>
                                <div className="absolute top-4 right-4 opacity-20"><Icons.Layers className="w-24 h-24"/></div>
                                <h3 className="text-3xl font-bold text-white mb-2 relative z-10">{d.name}</h3>
                                <p className="text-white/80 mb-6 text-sm h-10 leading-relaxed relative z-10">{d.desc}</p>
                                <div className="flex flex-wrap gap-2 relative z-10">
                                    <span className="bg-black/30 px-3 py-1 rounded-full text-xs font-bold text-blue-200">å‡ºç‰Œ: {d.stats.hands}</span>
                                    <span className="bg-black/30 px-3 py-1 rounded-full text-xs font-bold text-red-200">å¼ƒç‰Œ: {d.stats.discards}</span>
                                    <span className="bg-black/30 px-3 py-1 rounded-full text-xs font-bold text-yellow-200">é‡‘é’±: ${d.stats.money}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                    <button onClick={() => setGameState('menu')} className="mt-auto mb-4 text-slate-400 hover:text-white flex items-center gap-2"><Icons.Rotate className="w-5 h-5"/> è¿”å›ä¸»èœå•</button>
                </div>
            );
            
            // å•†åº—
            if (gameState === 'shop') return (
                 <div className="absolute inset-0 z-40 flex flex-col items-center bg-slate-800 rounded-xl p-4 sm:p-6 border-4 border-yellow-600/30 overflow-y-auto w-full h-full">
                    <div className="flex justify-between w-full items-center mb-6 border-b border-slate-700 pb-4 sticky top-0 bg-slate-800 z-10"><h2 className="text-2xl sm:text-3xl font-bold text-yellow-500 flex items-center gap-2"><Icons.ShoppingBag className="w-8 h-8"/> å•†åº—</h2><div className="text-lg sm:text-xl font-mono bg-slate-900 px-4 py-1 rounded text-yellow-400">æ‹¥æœ‰: ${money}</div></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full flex-1">
                        <div className="flex flex-col gap-4">
                            <div className="text-slate-400 font-bold uppercase tracking-wider text-sm border-b border-slate-700 pb-2">é“å…·åŒº (MTç‰Œ)</div>
                            <div className="flex flex-wrap gap-4">{shopJokers.filter(i=>i.type.includes('mult')||i.type.includes('chips')||i.type.includes('bonus')).length > 0 ? shopJokers.filter(i=>i.type.includes('mult')||i.type.includes('chips')||i.type.includes('bonus')).map((item, idx) => (<div key={item.uid} className="flex flex-col gap-2 items-center bg-slate-700/30 p-2 rounded-lg"><JokerCard joker={item} /><button onClick={() => buyItem(item, idx)} disabled={money < item.cost} className={`w-full py-2 rounded text-sm font-bold shadow-md active:scale-95 transition-transform ${money >= item.cost ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>${item.cost} è´­ä¹°</button></div>)) : <div className="text-slate-600 italic p-4">æ— é“å…·</div>}</div>
                        </div>
                        <div className="flex flex-col gap-4">
                            <div className="text-slate-400 font-bold uppercase tracking-wider text-sm border-b border-slate-700 pb-2">è¡¥ç»™åŒº (æ¶ˆè€—å“)</div>
                            <div className="flex flex-wrap gap-4">{shopJokers.filter(i=>!i.type.includes('mult')&&!i.type.includes('chips')&&!i.type.includes('bonus')).length > 0 ? shopJokers.filter(i=>!i.type.includes('mult')&&!i.type.includes('chips')&&!i.type.includes('bonus')).map((item, idx) => (<div key={item.uid} className="flex flex-col gap-2 items-center bg-slate-700/30 p-2 rounded-lg"><JokerCard joker={item} /><button onClick={() => buyItem(item, idx)} disabled={money < item.cost} className={`w-full py-2 rounded text-sm font-bold shadow-md active:scale-95 transition-transform ${money >= item.cost ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>${item.cost} è´­ä¹°</button></div>)) : <div className="text-slate-600 italic p-4">æ— è¡¥ç»™</div>}</div>
                        </div>
                    </div>
                    <button onClick={nextRound} className="mt-8 bg-red-600 hover:bg-red-500 active:bg-red-700 text-white font-bold py-4 px-12 rounded-xl text-xl shadow-lg transition-all flex items-center gap-2 w-full sm:w-auto justify-center mb-4">ä¸‹ä¸€å›åˆ <Icons.Play className="w-6 h-6" fill="currentColor"/></button>
                    {message && <div className="fixed top-24 bg-yellow-500 text-black px-4 py-2 rounded-lg font-bold shadow-xl animate-bounce z-50">{message}</div>}
                </div>
            );

            // æ¸¸æˆç»“æŸ
            if (gameState === 'gameover') return (
                <div className="absolute inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-10 text-center animate-in fade-in duration-500">
                    <h2 className="text-7xl font-black text-red-600 mb-8 tracking-tighter">è´¥åŒ—</h2>
                    <p className="text-slate-400 mb-8">æœ€ç»ˆå›åˆ: {round} - åˆ†æ•°: {currentScore}</p>
                    <button onClick={() => setGameState('menu')} className="bg-white text-black px-12 py-5 rounded-2xl font-black text-xl hover:bg-gray-200 transition-colors flex items-center gap-2"><Icons.Rotate className="w-6 h-6"/> å›åˆ°ç°å®</button>
                </div>
            );

            // æˆ˜æ–—ç•Œé¢
            return (
                <div className="flex flex-col h-full bg-slate-900 overflow-hidden font-sans w-full">
                    {/* å¼¹çª— */}
                    {showSettings && <SettingsModal onClose={() => setShowSettings(false)} onRestart={restartGame} onMenu={() => setGameState('menu')} onShowRules={() => { setShowSettings(false); setShowRuleModal(true); }} onShowJokerCompendium={() => { setShowSettings(false); setShowJokerCompendium(true); }} />}
                    {showRunInfo && <RunInfoModal handStats={handStats} onClose={() => setShowRunInfo(false)} />}
                    {showDeckView && <DeckViewModal deck={deck} onClose={() => setShowDeckView(false)} />}
                    {showRuleModal && <RuleModal onClose={() => setShowRuleModal(false)} />}
                    {showJokerCompendium && <ProductCompendiumModal onClose={() => setShowJokerCompendium(false)} />}
                    
                    {/* é¡¶éƒ¨æ  */}
                    <div className="w-full bg-slate-800 p-2 sm:p-3 shadow-lg border-b border-slate-700 z-10 flex flex-col gap-2">
                        <div className="flex justify-between items-center">
                            <div className="flex gap-2">
                                <button onClick={() => setShowSettings(true)} className="bg-slate-700 text-white px-2 py-1 rounded text-xs font-bold flex gap-1"><Icons.Settings className="w-4 h-4"/> è®¾ç½®</button>
                                <button onClick={() => setShowRunInfo(true)} className="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold flex gap-1"><Icons.BarChart className="w-4 h-4"/> ä¿¡æ¯</button>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowDeckView(true)} className="bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold flex gap-1"><Icons.Eye className="w-4 h-4"/> ç‰Œç»„</button>
                                <span className="text-xs text-slate-400">åº•æ³¨ <span className="text-orange-400 font-bold">#{round}</span></span>
                            </div>
                        </div>
                        <div className="flex justify-between items-end relative">
                            <div className="flex flex-col"><span className="text-[10px] text-slate-400 uppercase">å¾—åˆ†</span><div className="text-2xl font-mono font-black leading-none">{Math.floor(currentScore).toLocaleString()} <span className="text-sm text-slate-500">/ {Math.floor(targetScore).toLocaleString()}</span></div></div>
                            {/* 2. ä¼˜åŒ–ï¼šè®¡åˆ†é¢„è§ˆæ¡†æ”¾å¤§ */}
                            {currentHandType && selectedCards.length > 0 && (
                                <div className="absolute left-1/2 -translate-x-1/2 -translate-y-4 bg-slate-900 border-2 border-indigo-500 px-6 py-2 rounded-xl shadow-2xl flex flex-col items-center min-w-[200px] z-20">
                                    <div className="text-xs text-indigo-300 font-bold uppercase tracking-widest">{HAND_NAMES[currentHandType]} <span className="text-indigo-500">Lv.{currentHandInfo.level}</span></div>
                                    <div className="font-mono font-black leading-none text-3xl mt-1"><span className="text-blue-400">{previewData.totalChips}</span> X <span className="text-red-400">{previewData.totalMult}</span></div>
                                </div>
                            )}
                            <div className="flex items-center gap-3">
                                <div className="flex flex-col items-center"><span className="text-[10px] text-blue-400">å‡ºç‰Œ</span><span className="text-lg font-bold">{handsLeft}</span></div>
                                <div className="flex flex-col items-center"><span className="text-[10px] text-red-400">å¼ƒç‰Œ</span><span className="text-lg font-bold">{discardsLeft}</span></div>
                                <div className="flex flex-col items-center bg-yellow-900/30 px-2 py-0.5 rounded border border-yellow-700/50"><span className="text-[10px] text-yellow-500 flex items-center gap-1"><Icons.ShoppingBag className="w-3 h-3"/> é‡‘é’±</span><span className="text-lg font-bold text-yellow-400">${money}</span></div>
                            </div>
                        </div>
                        <div className="w-full h-1 bg-slate-700/50 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-blue-500 to-red-500 transition-all duration-500" style={{ width: `${Math.min((currentScore / targetScore) * 100, 100)}%` }} /></div>
                    </div>

                    {/* MT/æ¶ˆè€—å“æ  */}
                    <div className="w-full flex gap-2 p-2 bg-slate-900">
                        <div className="flex-1 h-24 flex items-center justify-start gap-2 p-2 rounded-xl border border-dashed border-slate-700 bg-slate-800/50 overflow-x-auto hide-scrollbar">
                            {myJokers.length === 0 && <span className="text-slate-600 text-xs w-full text-center">æš‚æ— MT (ä¸Šé™:{maxJokers})</span>}
                            {myJokers.map(joker => <JokerCard key={joker.uid} joker={joker} onSell={sellItem} />)}
                        </div>
                        <div className="w-1/3 h-24 flex items-center justify-start gap-2 p-2 rounded-xl border border-dashed border-blue-900/50 bg-slate-800/50 overflow-x-auto hide-scrollbar">
                            {consumables.length === 0 && <span className="text-slate-600 text-xs w-full text-center">æ¶ˆè€—å“ ({consumables.length}/{maxConsumables})</span>}
                            {consumables.map(item => (<div key={item.uid} className="relative group flex-shrink-0"><JokerCard joker={item} onSell={sellItem} /><button onClick={() => useConsumable(item)} className="absolute bottom-0 left-0 w-full bg-blue-600 text-[8px] text-white opacity-0 group-hover:opacity-100 transition-opacity">ä½¿ç”¨</button></div>))}
                        </div>
                    </div>

                    {/* æ¸¸æˆä¸»åŒºåŸŸ */}
                    <div className="flex-1 relative flex flex-col items-center justify-center p-2 w-full overflow-hidden">
                        {/* è®¡åˆ†å±•ç¤ºåŠ¨ç”» */}
                        {gameState === 'scoring' && scoreBreakdown && (
                            <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm rounded-xl animate-in fade-in zoom-in duration-300">
                                <div className="text-3xl font-bold text-white mb-2">{scoreBreakdown.name}</div>
                                <div className="flex items-center gap-2 text-2xl font-mono mb-4"><div className="bg-blue-600 px-3 py-1 rounded text-white">{scoreBreakdown.baseChips + scoreBreakdown.cardChips}</div><Icons.XCircle className="w-6 h-6 text-slate-400"/><div className="bg-red-600 px-3 py-1 rounded text-white">{scoreBreakdown.finalMult}</div></div>
                                <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-sm">{scoreBreakdown.total}</div>
                            </div>
                        )}
                        <div className="flex flex-wrap justify-center gap-1 sm:gap-2 w-full px-1">
                            {hand.map(card => <Card key={card.id} card={card} onClick={(c) => toggleSelect(c)} animationState={actionState} />)}
                        </div>
                        
                        {/* æ’åºæŒ‰é’® */}
                        <div className="flex gap-2 mt-4 w-full max-w-md px-4">
                             <button onClick={() => setHand(prev => [...prev].sort((a,b) => b.rankIndex - a.rankIndex))} className="flex-1 bg-slate-800 text-slate-400 py-2 rounded text-xs border border-slate-700">æŒ‰ç‚¹æ•°</button>
                             <button onClick={() => setHand(prev => [...prev].sort((a,b) => a.suit.localeCompare(b.suit)))} className="flex-1 bg-slate-800 text-slate-400 py-2 rounded text-xs border border-slate-700">æŒ‰èŠ±è‰²</button>
                        </div>
                    </div>

                    {/* åº•éƒ¨åŠ¨ä½œæ  */}
                    <div className="p-3 bg-slate-800/80 flex gap-3 border-t border-slate-700 w-full">
                        <button onClick={playHand} disabled={selectedCards.length === 0 || gameState === 'scoring'} className={`flex-1 py-4 rounded-xl font-black text-xl shadow-lg transition-all ${selectedCards.length > 0 ? 'bg-orange-500 text-white shadow-orange-500/30 active:scale-95' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>å‡ºç‰Œ</button>
                        <button onClick={discardHand} disabled={selectedCards.length === 0 || discardsLeft <= 0 || gameState === 'scoring'} className={`flex-1 py-4 rounded-xl font-black text-xl transition-all ${selectedCards.length > 0 && discardsLeft > 0 ? 'bg-red-600 text-white active:scale-95 shadow-lg shadow-red-900/20' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>å¼ƒç‰Œ</button>
                    </div>

                    {message && <div className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-yellow-500 text-black px-8 py-4 rounded-2xl font-black text-xl shadow-2xl z-[100] animate-bounce border-2 border-white pointer-events-none whitespace-nowrap">{message}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>