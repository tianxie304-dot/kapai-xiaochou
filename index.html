<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WEB MT - MTTTTTå¡ç‰Œ (æœ€ç»ˆä¿®å¤ç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS (ç”¨äºæ ·å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- å¼•å…¥ Babel (ç”¨äºè§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* é˜²æ­¢æ‰‹æœºç«¯åŒå‡»ç¼©æ”¾ */
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        /* ç®€å•çš„å¡ç‰Œç¿»è½¬æ•ˆæœå®¹å™¨ */
        .perspective-1000 { perspective: 1000px; }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* --- åŠ¨ç”»æ•ˆæœ --- */
        .card-spring { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s, border-color 0.2s, margin 0.2s; }
        @keyframes fly-up { 
            0% { transform: translateY(-24px) scale(1.05); opacity: 1; }
            20% { transform: translateY(-10px) scale(0.9); opacity: 1; } 
            100% { transform: translateY(-200px) scale(0.8) rotate(5deg); opacity: 0; }
        }
        .animate-fly-up { animation: fly-up 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fly-down {
            0% { transform: translateY(-24px) scale(1.05); opacity: 1; }
            100% { transform: translateY(150px) scale(0.8) rotate(-10deg); opacity: 0; }
        }
        .animate-fly-down { animation: fly-down 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        /* å¡çš®å·´æ‹‰æµ®åŠ¨åŠ¨ç”» */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-3%); }
            50% { transform: translateY(3%); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 3s infinite ease-in-out;
        }

        /* ç‰¹æ®Šå¡ç‰Œæ•ˆæœ */
        .enhance-bonus { box-shadow: 0 0 10px #3b82f6; border-color: #60a5fa; } 
        .enhance-mult { box-shadow: 0 0 10px #ef4444; border-color: #f87171; } 
        .enhance-wild { border: 2px solid transparent; background-image: linear-gradient(white, white), linear-gradient(to right, violet, indigo, blue, green, yellow, orange, red); background-origin: border-box; background-clip: content-box, border-box; }
        .enhance-glass { background: rgba(255,255,255,0.9); position: relative; overflow: hidden; }
        .enhance-glass::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.8) 50%, transparent 55%); transform: rotate(30deg); pointer-events: none; }
        .enhance-steel { background: #e2e8f0; border-color: #94a3b8; color: #475569; }
        .enhance-gold { border-color: #eab308; background: #fefce8; box-shadow: inset 0 0 10px #facc15; }

        /* å…¨å±€èƒŒæ™¯è‰²é”å®š */
        html, body {
            background-color: #0f172a; /* Slate 900 */
            overscroll-behavior: none;
        }
        input, textarea {
            -webkit-user-select: auto !important;
            user-select: auto !important;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- å·¥å…·å‡½æ•° ---
        const generateUniqueId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        };
        
        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash = hash & hash; 
            }
            return hash;
        };

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconWrapper = ({ children, className, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Heart = ({ className, fill }) => <IconWrapper className={className} fill={fill}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></IconWrapper>;
        const Diamond = ({ className, fill }) => <IconWrapper className={className} fill={fill}><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0Z" /></IconWrapper>;
        const Club = ({ className, fill }) => <IconWrapper className={className} fill={fill}><path d="M17.5 19c0-3.037-2-5.5-4.5-5.5-.447 0-.88.078-1.293.226C12.333 12.398 13 10.828 13 9a5 5 0 1 0-10 0c0 1.828.667 3.398 1.293 4.726-.413-.148-.846-.226-1.293-.226-2.5 0-4.5 2.463-4.5 5.5 0 2.15 1.157 4.013 3 4.815V23h13v-.185c1.843-.802 3-2.665 3-4.815Z" /></IconWrapper>;
        const Spade = ({ className, fill }) => <IconWrapper className={className} fill={fill}><path d="M5 9c0 5.25 5 13 7 13 2 0 7-7.75 7-13 0-3.5-2-5.5-5-5.5-1.5 0-3 1.5-3.5 2.5C10 5 8.5 3.5 7 3.5 4 3.5 2 5.5 5 9Z" /><path d="M12 14v8" stroke="currentColor"/></IconWrapper>;
        const ShoppingBag = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></IconWrapper>;
        const RotateCcw = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>;
        const Play = ({ size, fill }) => <IconWrapper className={`w-${size/4} h-${size/4}`} fill={fill}><polygon points="5 3 19 12 5 21 5 3" /></IconWrapper>;
        const XCircle = ({ size, className }) => <IconWrapper className={className || `w-${size/4} h-${size/4}`}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconWrapper>;
        const HelpCircle = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconWrapper>;
        const X = ({ size, className }) => <IconWrapper className={className || `w-${size/4} h-${size/4}`}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const BarChart3 = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconWrapper>;
        const Layers = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconWrapper>;
        const Trash2 = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></IconWrapper>;
        const Sparkles = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 5h4" /></IconWrapper>;
        const Zap = ({ size, className }) => <IconWrapper className={className || `w-${size/4} h-${size/4}`}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconWrapper>;
        const Eye = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const Settings = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const Home = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>;
        const Lock = ({ size }) => <IconWrapper className={`w-${size/4} h-${size/4}`}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconWrapper>;

        // --- å¡çš®å·´æ‹‰å¤´åƒç»„ä»¶ ---
        const CapybaraAvatar = () => (
            <div className="w-40 h-40 sm:w-56 sm:h-56 relative mb-6 animate-bounce-slow">
                <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-2xl filter saturate-110">
                    <defs><filter id="shadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="4" stdDeviation="4" floodColor="rgba(0,0,0,0.3)"/></filter></defs>
                    <circle cx="50" cy="70" r="20" fill="#a67c52" /><circle cx="150" cy="70" r="20" fill="#a67c52" /><circle cx="50" cy="70" r="12" fill="#8a623e" /><circle cx="150" cy="70" r="12" fill="#8a623e" /><rect x="40" y="50" width="120" height="110" rx="55" fill="#c49a6c" /><rect x="60" y="100" width="80" height="50" rx="25" fill="#d6b083" opacity="0.5" /><circle cx="70" cy="95" r="6" fill="#2d2d2d" /><circle cx="130" cy="95" r="6" fill="#2d2d2d" /><circle cx="72" cy="93" r="2" fill="white" /><circle cx="132" cy="93" r="2" fill="white" /><path d="M 90 115 L 110 115 L 100 125 Z" fill="#5c4033" /><line x1="100" y1="125" x2="100" y2="135" stroke="#5c4033" strokeWidth="3" strokeLinecap="round" /><path d="M 90 135 Q 100 145 110 135" stroke="#5c4033" strokeWidth="3" fill="none" strokeLinecap="round" /><circle cx="55" cy="115" r="8" fill="#f472b6" opacity="0.4" /><circle cx="145" cy="115" r="8" fill="#f472b6" opacity="0.4" /><circle cx="100" cy="40" r="18" fill="#fbbf24" stroke="#d97706" strokeWidth="2" /><path d="M 100 22 L 105 15" stroke="#15803d" strokeWidth="3" strokeLinecap="round" /><path d="M 100 22 L 90 18" stroke="#15803d" strokeWidth="3" strokeLinecap="round" /><path d="M 100 25 Q 110 25 108 35" fill="none" stroke="#f59e0b" strokeWidth="2" opacity="0.6" />
                </svg>
            </div>
        );

        // --- å¸¸é‡å®šä¹‰ ---
        const SUITS = [{ type: 'spade', icon: Spade, color: 'text-slate-300', name: 'é»‘æ¡ƒ' }, { type: 'heart', icon: Heart, color: 'text-red-500', name: 'çº¢æ¡ƒ' }, { type: 'club', icon: Club, color: 'text-indigo-400', name: 'æ¢…èŠ±' }, { type: 'diamond', icon: Diamond, color: 'text-orange-500', name: 'æ–¹ç‰‡' }];
        const RANKS = [{ label: '2', value: 2 }, { label: '3', value: 3 }, { label: '4', value: 4 }, { label: '5', value: 5 }, { label: '6', value: 6 }, { label: '7', value: 7 }, { label: '8', value: 8 }, { label: '9', value: 9 }, { label: '10', value: 10 }, { label: 'J', value: 10 }, { label: 'Q', value: 10 }, { label: 'K', value: 10 }, { label: 'A', value: 11 }];
        const HAND_NAMES = { 'High Card': 'é«˜ç‰Œ', 'Pair': 'å¯¹å­', 'Two Pair': 'ä¸¤å¯¹', 'Three of a Kind': 'ä¸‰æ¡', 'Straight': 'é¡ºå­', 'Flush': 'åŒèŠ±', 'Full House': 'è‘«èŠ¦', 'Four of a Kind': 'å››æ¡', 'Straight Flush': 'åŒèŠ±é¡º', 'Royal Flush': 'çš‡å®¶åŒèŠ±é¡º' };
        const DEFAULT_HAND_STATS = { 'High Card': { level: 1, chips: 5, mult: 1, name: 'é«˜ç‰Œ' }, 'Pair': { level: 1, chips: 10, mult: 2, name: 'å¯¹å­' }, 'Two Pair': { level: 1, chips: 20, mult: 2, name: 'ä¸¤å¯¹' }, 'Three of a Kind': { level: 1, chips: 30, mult: 3, name: 'ä¸‰æ¡' }, 'Straight': { level: 1, chips: 30, mult: 4, name: 'é¡ºå­' }, 'Flush': { level: 1, chips: 35, mult: 4, name: 'åŒèŠ±' }, 'Full House': { level: 1, chips: 40, mult: 4, name: 'è‘«èŠ¦' }, 'Four of a Kind': { level: 1, chips: 60, mult: 7, name: 'å››æ¡' }, 'Straight Flush': { level: 1, chips: 100, mult: 8, name: 'åŒèŠ±é¡º' }, 'Royal Flush': { level: 1, chips: 200, mult: 8, name: 'çš‡å®¶åŒèŠ±é¡º' } };
        const DECKS = [{ id: 'red', name: 'èµ¤çº¢å¡ç»„', desc: 'æ¯å›åˆ +1 å¼ƒç‰Œæ¬¡æ•°', color: 'from-red-900 to-red-700 border-red-500', stats: { hands: 4, discards: 4, money: 4, maxJokers: 5 } }, { id: 'blue', name: 'è”šè“å¡ç»„', desc: 'æ¯å›åˆ +1 å‡ºç‰Œæ¬¡æ•°', color: 'from-blue-900 to-blue-700 border-blue-500', stats: { hands: 5, discards: 3, money: 4, maxJokers: 5 } }, { id: 'yellow', name: 'é»„é‡‘å¡ç»„', desc: 'å¼€å±€æ‹¥æœ‰ $14', color: 'from-yellow-700 to-yellow-600 border-yellow-400', stats: { hands: 4, discards: 3, money: 14, maxJokers: 5 } }, { id: 'black', name: 'æš—é»‘å¡ç»„', desc: '+1 MTæ§½ä½ï¼Œ-1 å‡ºç‰Œæ¬¡æ•°', color: 'from-slate-800 to-black border-slate-500', stats: { hands: 3, discards: 3, money: 4, maxJokers: 6 } }, { id: 'green', name: 'ç¿ ç»¿å¡ç»„', desc: 'æ¯å›åˆç»“æŸæ—¶ï¼Œå‰©ä½™å‡ºç‰Œæ¬¡æ•°æä¾›é‡‘é’±', color: 'from-green-900 to-green-700 border-green-500', stats: { hands: 4, discards: 3, money: 4, maxJokers: 5 }, bonus: 'interest_hands' }, { id: 'checkered', name: 'æ–¹æ ¼å¡ç»„', desc: 'ç‰Œç»„ä¸­åªæœ‰é»‘æ¡ƒå’Œçº¢æ¡ƒ', color: 'from-orange-900 to-red-900 border-orange-500', stats: { hands: 4, discards: 3, money: 4, maxJokers: 5 }, type: 'checkered' }, { id: 'abandoned', name: 'åºŸå¼ƒå¡ç»„', desc: 'ç‰Œç»„ä¸­æ²¡æœ‰èŠ±ç‰Œ (J, Q, K)', color: 'from-gray-700 to-gray-900 border-gray-500', stats: { hands: 4, discards: 3, money: 4, maxJokers: 5 }, type: 'abandoned' }, { id: 'plasma', name: 'ç­‰ç¦»å­å¡ç»„', desc: 'è®¡ç®—åˆ†æ•°æ—¶å¹³è¡¡ç­¹ç å’Œå€ç‡ (å–å¹³å‡å€¼)', color: 'from-pink-900 to-purple-900 border-pink-500', stats: { hands: 4, discards: 3, money: 4, maxJokers: 5 }, type: 'plasma' }];
        const JOKERS_DB = [{ id: 'j_joker', name: 'MT', desc: '+4 å€ç‡', cost: 4, type: 'add_mult', value: 4 }, { id: 'j_greedy', name: 'è´ªå©ªMT', desc: 'æ‰“å‡ºæ–¹ç‰‡ç‰Œæ—¶ +4 å€ç‡', cost: 6, type: 'suit_mult', suit: 'diamond', value: 4 }, { id: 'j_wrath', name: 'æš´æ€’MT', desc: 'æ‰“å‡ºé»‘æ¡ƒç‰Œæ—¶ +4 å€ç‡', cost: 6, type: 'suit_mult', suit: 'spade', value: 4 }, { id: 'j_lust', name: 'è‰²æ¬²MT', desc: 'æ‰“å‡ºçº¢æ¡ƒç‰Œæ—¶ +4 å€ç‡', cost: 6, type: 'suit_mult', suit: 'heart', value: 4 }, { id: 'j_glut', name: 'æš´é£ŸMT', desc: 'æ‰“å‡ºæ¢…èŠ±ç‰Œæ—¶ +4 å€ç‡', cost: 6, type: 'suit_mult', suit: 'club', value: 4 }, { id: 'j_even', name: 'å¶æ•°MT', desc: 'æ‰“å‡ºå¶æ•°ç‰Œ(2,4,6,8,10) +4 å€ç‡', cost: 5, type: 'rank_mod_mult', mod: 0, value: 4 }, { id: 'j_odd', name: 'å¥‡æ•°MT', desc: 'æ‰“å‡ºå¥‡æ•°ç‰Œ(A,3,5,7,9) +30 ç­¹ç ', cost: 5, type: 'rank_mod_chips', mod: 1, value: 30 }, { id: 'j_scholar', name: 'å­¦è€…', desc: 'æ‰“å‡ºAæ—¶ +20 ç­¹ç  å’Œ +4 å€ç‡', cost: 8, type: 'card_specific', label: 'A', chips: 20, mult: 4 }, { id: 'j_half', name: 'åŠä¸ªMT', desc: 'å¦‚æœæ‰“å‡ºçš„ç‰Œ<=3å¼ ï¼Œ+15 å€ç‡', cost: 10, type: 'count_less', count: 3, value: 15 }, { id: 'j_banner', name: 'æ——å¸œ', desc: 'æ¯æ¬¡å‰©ä½™å¼ƒç‰Œæ¬¡æ•° +40 ç­¹ç ', cost: 8, type: 'discard_bonus', value: 40 }];
        const PLANETS_DB = [{ id: 'p_mercury', name: 'æ°´æ˜Ÿ', desc: 'å‡çº§ [å¯¹å­]', cost: 4, type: 'planet', target: 'Pair', chipsMod: 15, multMod: 1, color: 'bg-slate-500' }, { id: 'p_venus', name: 'é‡‘æ˜Ÿ', desc: 'å‡çº§ [ä¸‰æ¡]', cost: 5, type: 'planet', target: 'Three of a Kind', chipsMod: 20, multMod: 2, color: 'bg-yellow-600' }, { id: 'p_earth', name: 'åœ°çƒ', desc: 'å‡çº§ [è‘«èŠ¦]', cost: 6, type: 'planet', target: 'Full House', chipsMod: 25, multMod: 2, color: 'bg-green-600' }, { id: 'p_mars', name: 'ç«æ˜Ÿ', desc: 'å‡çº§ [å››æ¡]', cost: 7, type: 'planet', target: 'Four of a Kind', chipsMod: 30, multMod: 3, color: 'bg-red-600' }, { id: 'p_jupiter', name: 'æœ¨æ˜Ÿ', desc: 'å‡çº§ [åŒèŠ±]', cost: 6, type: 'planet', target: 'Flush', chipsMod: 15, multMod: 2, color: 'bg-orange-700' }, { id: 'p_saturn', name: 'åœŸæ˜Ÿ', desc: 'å‡çº§ [é¡ºå­]', cost: 6, type: 'planet', target: 'Straight', chipsMod: 20, multMod: 2, color: 'bg-yellow-800' }, { id: 'p_uranus', name: 'å¤©ç‹æ˜Ÿ', desc: 'å‡çº§ [ä¸¤å¯¹]', cost: 5, type: 'planet', target: 'Two Pair', chipsMod: 15, multMod: 1, color: 'bg-cyan-600' }, { id: 'p_neptune', name: 'æµ·ç‹æ˜Ÿ', desc: 'å‡çº§ [åŒèŠ±é¡º]', cost: 8, type: 'planet', target: 'Straight Flush', chipsMod: 40, multMod: 4, color: 'bg-blue-700' }, { id: 'p_pluto', name: 'å†¥ç‹æ˜Ÿ', desc: 'å‡çº§ [é«˜ç‰Œ]', cost: 3, type: 'planet', target: 'High Card', chipsMod: 10, multMod: 1, color: 'bg-gray-600' }];
        const TAROTS_DB = [{ id: 't_fool', name: 'æ„šè€…', desc: 'ç”Ÿæˆä¸Šä¸€å¼ ä½¿ç”¨çš„å¡”ç½—ç‰Œæˆ–æ˜Ÿçƒç‰Œ (æœ¬ç‰ˆæš‚æœªå®ç°)', cost: 4, type: 'tarot', effect: 'spawn_last', color: 'bg-indigo-600' }, { id: 't_magician', name: 'é­”æœ¯å¸ˆ', desc: 'å°†è‡³å¤š2å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [ä¸‡èƒ½å¡]', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'wild', maxCards: 2, color: 'bg-purple-700' }, { id: 't_empress', name: 'å¥³çš‡', desc: 'å°†è‡³å¤š2å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [å€ç‡å¡] (+4 å€ç‡)', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'mult', maxCards: 2, color: 'bg-pink-700' }, { id: 't_hierophant', name: 'æ•™çš‡', desc: 'å°†è‡³å¤š2å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [ç­¹ç å¡] (+30 ç­¹ç )', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'bonus', maxCards: 2, color: 'bg-green-700' }, { id: 't_lovers', name: 'æ‹äºº', desc: 'å°†è‡³å¤š1å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [ä¸‡èƒ½å¡]', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'wild', maxCards: 1, color: 'bg-rose-600' }, { id: 't_chariot', name: 'æˆ˜è½¦', desc: 'å°†è‡³å¤š1å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [é’¢é“å¡]', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'steel', maxCards: 1, color: 'bg-slate-500' }, { id: 't_hermit', name: 'éšè€…', desc: 'é‡‘é’±ç¿»å€ (æœ€å¤š +$20)', cost: 4, type: 'tarot', effect: 'money', amount: 20, color: 'bg-emerald-700' }, { id: 't_devil', name: 'æ¶é­”', desc: 'å°†è‡³å¤š1å¼ é€‰ä¸­çš„ç‰Œå¢å¼ºä¸º [é»„é‡‘å¡]', cost: 4, type: 'tarot', effect: 'enhance', enhanceType: 'gold', maxCards: 1, color: 'bg-yellow-700' }];
        const SPECTRAL_DB = [{ id: 's_immolate', name: 'çŒ®ç¥­', desc: 'éšæœºæ‘§æ¯5å¼ æ‰‹ç‰Œï¼Œè·å¾—$20', cost: 6, type: 'spectral', effect: 'destroy_hand_money', count: 5, amount: 20, color: 'bg-blue-900 border-2 border-blue-400' }, { id: 's_cryptid', name: 'ç¥ç§˜ç”Ÿç‰©', desc: 'å¤åˆ¶2å¼ é€‰ä¸­çš„ç‰Œ', cost: 6, type: 'spectral', effect: 'copy', count: 2, color: 'bg-fuchsia-900 border-2 border-fuchsia-400' }];
        const ENHANCED_CARDS_DB = [{ id: 'ec_bonus_ace', name: 'ç­¹ç A', desc: 'ä¸€å¼ å¢å¼ºçš„é»‘æ¡ƒA (+30ç­¹ç )', cost: 6, type: 'playing_card', rank: 12, suit: 'spade', enhance: 'bonus' }, { id: 'ec_mult_king', name: 'å€ç‡K', desc: 'ä¸€å¼ å¢å¼ºçš„çº¢æ¡ƒK (+4å€ç‡)', cost: 7, type: 'playing_card', rank: 11, suit: 'heart', enhance: 'mult' }, { id: 'ec_wild_queen', name: 'ä¸‡èƒ½Q', desc: 'ä¸€å¼ å¢å¼ºçš„æ¢…èŠ±Q (ä¸‡èƒ½èŠ±è‰²)', cost: 8, type: 'playing_card', rank: 10, suit: 'club', enhance: 'wild' }, { id: 'ec_steel_ten', name: 'é’¢é“10', desc: 'ä¸€å¼ å¢å¼ºçš„æ–¹ç‰‡10 (æ‰‹æŒx1.5å€)', cost: 6, type: 'playing_card', rank: 8, suit: 'diamond', enhance: 'steel' }, { id: 'ec_gold_two', name: 'é»„é‡‘2', desc: 'ä¸€å¼ å¢å¼ºçš„é»‘æ¡ƒ2 (å›åˆç»“æŸ+$3)', cost: 5, type: 'playing_card', rank: 0, suit: 'spade', enhance: 'gold' }];

        // --- è¾…åŠ©å‡½æ•° ---
        const createDeck = (deckType) => {
            let deck = [];
            if (deckType === 'checkered') { ['spade', 'heart'].forEach(suit => { for(let i=0; i<2; i++) { RANKS.forEach((rank, index) => { deck.push({ id: generateUniqueId(), suit: suit, rankLabel: rank.label, value: rank.value, rankIndex: index, selected: false }); }); } }); return deck; }
            SUITS.forEach(suit => { RANKS.forEach((rank, index) => { if (deckType === 'abandoned' && (rank.label === 'J' || rank.label === 'Q' || rank.label === 'K')) return; deck.push({ id: generateUniqueId(), suit: suit.type, rankLabel: rank.label, value: rank.value, rankIndex: index, selected: false, suitName: suit.name }); }); });
            return deck;
        };

        const shuffle = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; }
            return array;
        };

        const detectHandType = (cards) => {
            if (cards.length === 0) return null;
            const sorted = [...cards].sort((a, b) => a.rankIndex - b.rankIndex);
            const ranks = sorted.map(c => c.rankIndex);
            const nonWilds = cards.filter(c => c.enhance !== 'wild');
            let isFlush = false;
            if (cards.length === 5) {
                if (nonWilds.length === 0) isFlush = true; 
                else { const firstSuit = nonWilds[0].suit; isFlush = nonWilds.every(c => c.suit === firstSuit); }
            }
            let isStraight = false;
            let uniqueRanks = [...new Set(ranks)];
            if (cards.length === 5) {
                if (uniqueRanks.length === 5 && uniqueRanks[4] - uniqueRanks[0] === 4) isStraight = true;
                if (!isStraight && uniqueRanks.length === 5 && JSON.stringify(uniqueRanks) === JSON.stringify([0, 1, 2, 3, 12])) isStraight = true;
            }
            const counts = {};
            ranks.forEach(r => counts[r] = (counts[r] || 0) + 1);
            const countValues = Object.values(counts).sort((a, b) => b - a);
            let type = 'High Card';
            if (isFlush && isStraight) { const isRoyal = ranks[0] === 8 && ranks[4] === 12; type = isRoyal ? 'Royal Flush' : 'Straight Flush'; }
            else if (countValues[0] === 4) type = 'Four of a Kind';
            else if (countValues[0] === 3 && countValues[1] === 2) type = 'Full House';
            else if (isFlush) type = 'Flush';
            else if (isStraight) type = 'Straight';
            else if (countValues[0] === 3) type = 'Three of a Kind';
            else if (countValues[0] === 2 && countValues[1] === 2) type = 'Two Pair';
            else if (countValues[0] === 2) type = 'Pair';
            return type;
        };

        // ç»„ä»¶å®šä¹‰...
        const Card = ({ card, onClick, mini = false, medium = false, animationState }) => {
            const suitConfig = SUITS.find(s => s.type === card.suit);
            const Icon = suitConfig.icon;
            let animClass = '';
            if (card.selected) {
                if (animationState === 'scoring') animClass = 'animate-fly-up';
                else if (animationState === 'discarding') animClass = 'animate-fly-down';
            }
            let enhanceClass = '';
            if (card.enhance === 'bonus') enhanceClass = 'enhance-bonus';
            if (card.enhance === 'mult') enhanceClass = 'enhance-mult';
            if (card.enhance === 'wild') enhanceClass = 'enhance-wild';
            if (card.enhance === 'glass') enhanceClass = 'enhance-glass';
            if (card.enhance === 'steel') enhanceClass = 'enhance-steel';
            if (card.enhance === 'gold') enhanceClass = 'enhance-gold';
            
            let sizeClasses = 'w-14 h-24 text-lg sm:w-20 sm:h-32 sm:text-xl md:w-24 md:h-36 md:text-2xl'; 
            if (mini) sizeClasses = 'w-8 h-12 text-[10px]';
            else if (medium) sizeClasses = 'w-12 h-20 text-sm';

            const baseClasses = `
                relative flex flex-col items-center justify-center 
                bg-white border-2 rounded-lg shadow-md select-none cursor-pointer flex-shrink-0 card-spring
                ${card.selected ? '-translate-y-6 z-30 border-blue-400 shadow-xl ring-2 ring-blue-300' : 'border-gray-200 hover:-translate-y-4 hover:z-20 z-0'}
                ${sizeClasses}
                ${animClass} ${enhanceClass} transition-all duration-200
            `;
            return (
                <div onClick={() => onClick && onClick(card)} className={baseClasses}>
                    <div className={`absolute top-1 left-1 flex flex-col items-center gap-0 leading-none ${suitConfig.color}`}>
                        <span className={`font-bold ${mini ? 'text-[8px]' : medium ? 'text-xs' : 'text-sm sm:text-lg'}`}>{card.rankLabel}</span>
                        <Icon className={`${mini ? 'w-2 h-2' : medium ? 'w-3 h-3' : 'w-3 h-3 sm:w-4 sm:h-4'}`} fill="currentColor" />
                    </div>
                    <Icon className={`${suitConfig.color} ${mini ? 'w-4 h-4' : medium ? 'w-6 h-6' : 'w-6 h-6 sm:w-10 sm:h-10'} opacity-90`} fill="currentColor" />
                    <div className={`absolute bottom-1 right-1 flex flex-col items-center gap-0 leading-none rotate-180 ${suitConfig.color}`}>
                        <span className={`font-bold ${mini ? 'text-[8px]' : medium ? 'text-xs' : 'text-sm sm:text-lg'}`}>{card.rankLabel}</span>
                        <Icon className={`${mini ? 'w-2 h-2' : medium ? 'w-3 h-3' : 'w-3 h-3 sm:w-4 sm:h-4'}`} fill="currentColor" />
                    </div>
                    {card.enhance && (
                        <div className="absolute top-0 right-0 p-0.5">
                            {card.enhance === 'bonus' && <span className="text-[8px] bg-blue-500 text-white px-1 rounded-bl">+30</span>}
                            {card.enhance === 'mult' && <span className="text-[8px] bg-red-500 text-white px-1 rounded-bl">+4M</span>}
                            {card.enhance === 'wild' && <span className="text-[8px] bg-purple-500 text-white px-1 rounded-bl">ä¸‡èƒ½</span>}
                            {card.enhance === 'steel' && <span className="text-[8px] bg-slate-500 text-white px-1 rounded-bl">x1.5</span>}
                            {card.enhance === 'gold' && <span className="text-[8px] bg-yellow-500 text-white px-1 rounded-bl">$</span>}
                        </div>
                    )}
                </div>
            );
        };

        const JokerCard = ({ joker, onSell }) => {
            let colorClass = 'bg-slate-800 border-yellow-500';
            if (joker.type === 'planet') colorClass = joker.color + ' border-white/30';
            if (joker.type === 'tarot') colorClass = joker.color + ' border-white/30';
            if (joker.type === 'spectral') colorClass = joker.color;
            if (joker.type === 'playing_card') colorClass = 'bg-white text-black border-gray-300';

            return (
                <div className={`relative flex flex-col items-center justify-center w-16 h-24 sm:w-20 sm:h-28 border-2 rounded-lg p-1 text-center shadow-lg group flex-shrink-0 ${colorClass}`}>
                    <div className={`font-bold text-xs mb-1 truncate w-full ${joker.type === 'playing_card' ? 'text-black' : 'text-white'}`}>{joker.name}</div>
                    <div className={`text-[9px] leading-tight break-words w-full h-full overflow-hidden flex items-center justify-center ${joker.type === 'playing_card' ? 'text-gray-600' : 'text-gray-200'}`}>{joker.desc}</div>
                    {onSell && (
                        <button onClick={() => onSell(joker)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md z-10 hover:bg-red-600 transition-colors"><XCircle size={14} className="text-white"/></button>
                    )}
                </div>
            );
        };

        const DeckViewModal = ({ deck, onClose }) => {
            const suitsOrder = ['spade', 'heart', 'club', 'diamond'];
            const groupedDeck = useMemo(() => {
                const groups = { spade: [], heart: [], club: [], diamond: [] };
                deck.forEach(card => { if (groups[card.suit]) groups[card.suit].push(card); });
                Object.keys(groups).forEach(suit => { groups[suit].sort((a, b) => a.rankIndex - b.rankIndex); });
                return groups;
            }, [deck]);

            return (
                <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-slate-800 border border-slate-600 rounded-xl max-w-5xl w-full max-h-[90vh] flex flex-col animate-in zoom-in-95 duration-200 shadow-2xl">
                        <div className="flex justify-between items-center p-4 border-b border-slate-700 sticky top-0 bg-slate-800 z-10"><h2 className="text-xl font-bold text-blue-400 flex items-center gap-2"><Eye size={24}/> å‰©ä½™ç‰Œç»„ ({deck.length}å¼ )</h2><button onClick={onClose} className="p-2 text-slate-400 hover:text-white bg-slate-700/50 rounded-full"><X size={24}/></button></div>
                        <div className="overflow-y-auto p-6 custom-scrollbar flex flex-col gap-6">
                            {suitsOrder.map(suit => (
                                <div key={suit} className="flex items-center gap-4 border-b border-slate-700/50 pb-4 last:border-0">
                                    <div className="w-12 flex justify-center text-slate-400">
                                        {suit === 'spade' && <Spade className="w-8 h-8 text-slate-300" fill="currentColor" />}
                                        {suit === 'heart' && <Heart className="w-8 h-8 text-red-500" fill="currentColor" />}
                                        {suit === 'club' && <Club className="w-8 h-8 text-indigo-400" fill="currentColor" />}
                                        {suit === 'diamond' && <Diamond className="w-8 h-8 text-orange-500" fill="currentColor" />}
                                    </div>
                                    <div className="flex flex-wrap gap-2 flex-1">
                                        {groupedDeck[suit].length > 0 ? (groupedDeck[suit].map(card => (<div key={card.id} className="relative"><Card card={card} medium={true} />{card.enhance && (<div className="absolute -top-2 -right-2 bg-yellow-500 text-black text-[9px] px-1 rounded-full font-bold shadow-sm z-10 whitespace-nowrap">{card.enhance === 'bonus' && '+30'}{card.enhance === 'mult' && '+4M'}{card.enhance === 'wild' && 'ä¸‡èƒ½'}{card.enhance === 'steel' && 'é’¢é“'}{card.enhance === 'gold' && 'é»„é‡‘'}</div>)}</div>))) : (<span className="text-slate-600 text-sm italic self-center">æ— </span>)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ item, onConfirm, onCancel }) => (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div className="bg-slate-800 border border-red-500 rounded-xl max-w-sm w-full p-6 shadow-2xl animate-in zoom-in-95 flex flex-col items-center text-center"><div className="bg-red-500/20 p-3 rounded-full mb-4"><Trash2 size={32} className="text-red-500" /></div><h3 className="text-xl font-bold text-white mb-2">ç¡®è®¤ç§»é™¤ {item.name}?</h3><p className="text-slate-400 mb-6 text-sm">æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚{!item.type.includes('playing_card') && <span> å‡ºå”®è·å¾— <span className="text-yellow-400 font-bold">${Math.floor(item.cost / 2)}</span></span>}</p><div className="flex gap-4 w-full"><button onClick={onCancel} className="flex-1 py-3 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-700 font-bold transition-colors">å–æ¶ˆ</button><button onClick={() => onConfirm(item)} className="flex-1 py-3 rounded-lg bg-red-600 text-white hover:bg-red-500 font-bold shadow-lg shadow-red-900/30 transition-colors">ç¡®è®¤ç§»é™¤</button></div></div></div>
        );

        const RuleModal = ({ onClose }) => (
            <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div className="bg-slate-800 border border-slate-600 rounded-xl max-w-lg w-full max-h-[80vh] overflow-y-auto shadow-2xl flex flex-col animate-in zoom-in-95 duration-200"><div className="flex justify-between items-center p-4 border-b border-slate-700 sticky top-0 bg-slate-800 z-10"><h2 className="text-2xl font-bold text-yellow-400 flex items-center gap-2"><HelpCircle size={28}/> æ¸¸æˆæŒ‡å—</h2><button onClick={onClose} className="p-2 text-slate-400 hover:text-white bg-slate-700/50 rounded-full hover:bg-slate-600 transition-colors"><X size={24}/></button></div><div className="p-6 space-y-6 text-slate-300 text-sm sm:text-base leading-relaxed overflow-y-auto custom-scrollbar"><div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50"><h3 className="text-white font-bold text-lg mb-2 flex items-center gap-2">ğŸ¯ 1. æ ¸å¿ƒç›®æ ‡</h3><p>è¿™æ˜¯ä¸€æ¬¾æ‰‘å…‹Roguelikeæ¸¸æˆã€‚æ¯ä¸€å…³éƒ½æœ‰ä¸€ä¸ª<span className="text-red-400 font-bold">ç›®æ ‡åˆ†æ•°</span>ã€‚</p><p className="mt-1">ä½ éœ€è¦æ‰“å‡ºæ‰‘å…‹ç‰Œæ‰‹ç‰Œï¼Œåˆ©ç”¨<span className="text-blue-300 font-mono">ç­¹ç </span> x <span className="text-red-400 font-mono">å€ç‡</span>çš„å…¬å¼èµšå–åˆ†æ•°ã€‚</p></div><div><h3 className="text-white font-bold text-lg mb-2 flex items-center gap-2">ğŸƒ 2. ç‰Œå‹è¯´æ˜ (ä»å¤§åˆ°å°)</h3><div className="grid grid-cols-2 gap-2 text-xs sm:text-sm"><div className="p-2 bg-slate-700/30 rounded"><span className="text-yellow-300 font-bold">çš‡å®¶åŒèŠ±é¡º</span>: åŒèŠ±è‰²çš„ 10, J, Q, K, A</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-blue-300 font-bold">åŒèŠ±é¡º</span>: åŒèŠ±è‰²çš„é¡ºå­</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-purple-300 font-bold">å››æ¡</span>: 4å¼ ç‚¹æ•°ç›¸åŒçš„ç‰Œ</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-orange-300 font-bold">è‘«èŠ¦</span>: 3å¼ ç›¸åŒ + 2å¼ ç›¸åŒ</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-green-300 font-bold">åŒèŠ±</span>: 5å¼ èŠ±è‰²ç›¸åŒ</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-cyan-300 font-bold">é¡ºå­</span>: 5å¼ ç‚¹æ•°è¿ç»­</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-white font-bold">ä¸‰æ¡</span>: 3å¼ ç‚¹æ•°ç›¸åŒ</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-white font-bold">ä¸¤å¯¹</span>: 2å¯¹ç‰Œ</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-white font-bold">å¯¹å­</span>: 2å¼ ç‚¹æ•°ç›¸åŒ</div><div className="p-2 bg-slate-700/30 rounded"><span className="text-gray-400 font-bold">é«˜ç‰Œ</span>: æ— ä»»ä½•ç‰Œå‹</div></div></div><div><h3 className="text-white font-bold text-lg mb-2 flex items-center gap-2">ğŸ§® 3. è®¡åˆ†å…¬å¼è¯¦è§£</h3><div className="bg-slate-700/30 p-3 rounded-lg font-mono text-center text-yellow-200 border border-yellow-500/20 shadow-inner mb-2">æ€»åˆ† = (åŸºç¡€ç­¹ç  + å¡ç‰Œç‚¹æ•° + åŠ æˆ) x (åŸºç¡€å€ç‡ + åŠ æˆ)</div><p>ä¸¾ä¾‹ï¼šæ‰“å‡º<span className="text-white font-bold">ä¸€å¯¹K</span> (æ¯å¼ Kæ˜¯10ç‚¹)ã€‚</p><ul className="list-disc pl-5 space-y-1 text-slate-400 text-sm"><li>ç‰Œå‹"å¯¹å­"åŸºç¡€å€¼ï¼š<span className="text-blue-300">10ç­¹ç </span> x <span className="text-red-400">2å€ç‡</span></li><li>å¡ç‰Œç‚¹æ•°ï¼šK(10) + K(10) = 20ç­¹ç </li><li>æ€»ç­¹ç  = 10 (åŸºç¡€) + 20 (å¡ç‰Œ) = 30</li><li>æ€»å¾—åˆ† = 30 x 2 = 60åˆ†</li></ul><p className="mt-2 text-yellow-300 text-sm">ğŸ’¡ æç¤ºï¼šMTç‰Œ(Joker)é€šå¸¸æä¾›å¤§é‡çš„â€œ+å€ç‡â€æˆ–â€œxå€ç‡â€ï¼Œæ˜¯è·å¾—é«˜åˆ†çš„å…³é”®ï¼</p></div><div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><h3 className="text-white font-bold text-lg mb-2">ğŸ’° 4. ç»æµç³»ç»Ÿ</h3><ul className="space-y-2 text-sm"><li><strong className="text-yellow-400">åŸºç¡€å¥–åŠ±ï¼š</strong>è¿‡å…³è·å¾— $3 + å‰©ä½™å‡ºç‰Œæ¬¡æ•°å¥–åŠ±ã€‚</li><li><strong className="text-green-400">åˆ©æ¯ï¼š</strong>æ¯æŒæœ‰$5è·å¾—$1åˆ©æ¯(ä¸Šé™$5)ã€‚</li></ul></div><div><h3 className="text-white font-bold text-lg mb-2">ğŸ›ï¸ 5. å•†åº—é“å…·</h3><ul className="space-y-2 text-sm"><li><span className="text-yellow-400 font-bold">MTç‰Œ:</span> æ ¸å¿ƒè¢«åŠ¨è£…å¤‡ã€‚</li><li><span className="text-blue-400 font-bold">æ˜Ÿçƒç‰Œ:</span> å‡çº§ç‰Œå‹åŸºç¡€åˆ†å€¼ã€‚</li><li><span className="text-purple-400 font-bold">å¡”ç½—ç‰Œ:</span> å¢å¼ºå¡ç‰Œã€‚</li></ul></div></div></div><div className="p-4 border-t border-slate-700 text-center sticky bottom-0 bg-slate-800 rounded-b-xl"><button onClick={onClose} className="w-full bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg text-lg transition-transform active:scale-95">æˆ‘æ˜ç™½äº†ï¼Œå¼€å§‹æˆ˜æ–—ï¼</button></div></div></div>
        );

        const RunInfoModal = ({ handStats, onClose }) => (
            <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div className="bg-slate-800 border border-slate-600 rounded-xl max-w-2xl w-full max-h-[85vh] flex flex-col animate-in zoom-in-95 duration-200 shadow-2xl"><div className="flex justify-between items-center p-4 border-b border-slate-700 sticky top-0 bg-slate-800 z-10"><h2 className="text-xl font-bold text-red-400 flex items-center gap-2"><BarChart3 size={24}/> æ¯”èµ›ä¿¡æ¯ - ç‰Œå‹ç­‰çº§</h2><button onClick={onClose} className="p-2 text-slate-400 hover:text-white bg-slate-700/50 rounded-full"><X size={24}/></button></div><div className="overflow-y-auto p-4 custom-scrollbar"><div className="grid gap-3"><div className="grid grid-cols-4 text-xs sm:text-sm font-bold text-slate-400 uppercase tracking-wider px-2"><div>ç‰Œå‹</div><div className="text-center">ç­‰çº§</div><div className="text-center">ç­¹ç </div><div className="text-center">å€ç‡</div></div>{Object.values(handStats).map((stat, idx) => (<div key={idx} className="grid grid-cols-4 items-center bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 hover:bg-slate-700/30 transition-colors"><div className="font-bold text-white text-sm sm:text-base">{stat.name}</div><div className="flex justify-center"><span className={`px-2 py-0.5 rounded text-xs font-bold ${stat.level > 1 ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400'}`}>Lv.{stat.level}</span></div><div className="text-center font-mono text-blue-300 font-bold">{stat.chips}</div><div className="text-center font-mono text-red-400 font-bold">x{stat.mult}</div></div>))}</div></div></div></div>
        );

        const SettingsModal = ({ onClose, onRestart, onMenu }) => {
            const [viewRules, setViewRules] = useState(false);
            if (viewRules) return <RuleModal onClose={() => setViewRules(false)} />;
            return (
                <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div className="bg-slate-800 border border-slate-600 rounded-xl max-w-sm w-full p-6 shadow-2xl flex flex-col gap-4 animate-in zoom-in-95"><h2 className="text-2xl font-bold text-white text-center mb-2 flex items-center justify-center gap-2"><Settings size={28}/> è®¾ç½®</h2><button onClick={() => setViewRules(true)} className="bg-slate-700 hover:bg-slate-600 text-white p-3 rounded-lg font-bold flex items-center justify-center gap-2 border border-slate-600 transition-colors"><HelpCircle size={20}/> æŸ¥çœ‹è§„åˆ™</button><button onClick={() => { onRestart(); onClose(); }} className="bg-orange-600 hover:bg-orange-500 text-white p-3 rounded-lg font-bold flex items-center justify-center gap-2 border border-orange-400 shadow-lg shadow-orange-900/30 transition-colors"><RotateCcw size={20}/> é‡å¼€æœ¬å±€</button><button onClick={() => { onMenu(); onClose(); }} className="bg-red-600 hover:bg-red-500 text-white p-3 rounded-lg font-bold flex items-center justify-center gap-2 border border-red-400 shadow-lg shadow-red-900/30 transition-colors"><Home size={20}/> è¿”å›ä¸»èœå•</button><button onClick={onClose} className="mt-2 text-slate-400 hover:text-white text-sm">å…³é—­èœå•</button></div></div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (simpleHash(input) === 73669169) onLogin(); else { setError('å¯†ç é”™è¯¯'); setTimeout(() => setError(''), 2000); } };
            return (<div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 text-white p-4"><CapybaraAvatar /><h1 className="text-3xl font-bold mb-6 tracking-wider">ç³»ç»Ÿç™»å½•</h1><form onSubmit={handleSubmit} className="w-full max-w-xs flex flex-col gap-4"><input type="password" value={input} onChange={(e) => setInput(e.target.value)} placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " className="bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-center text-lg focus:outline-none focus:border-blue-500 transition-colors" autoFocus /><button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition-all">è¿›å…¥ç³»ç»Ÿ</button></form>{error && <div className="mt-4 text-red-400 text-sm animate-bounce">{error}</div>}</div>);
        };

        function App() {
            const [gameState, setGameState] = useState('login'); 
            const [showSettings, setShowSettings] = useState(false); 
            const [showRunInfo, setShowRunInfo] = useState(false);
            const [showDeckView, setShowDeckView] = useState(false);
            const [confirmAction, setConfirmAction] = useState(null); 
            const [actionState, setActionState] = useState('idle');
            const [handStats, setHandStats] = useState(DEFAULT_HAND_STATS); 
            const [selectedDeck, setSelectedDeck] = useState(null); 
            const [deck, setDeck] = useState([]);
            const [hand, setHand] = useState([]);
            const [round, setRound] = useState(1);
            const [targetScore, setTargetScore] = useState(300);
            const [currentScore, setCurrentScore] = useState(0);
            const [money, setMoney] = useState(4);
            const [handsLeft, setHandsLeft] = useState(4);
            const [discardsLeft, setDiscardsLeft] = useState(3);
            const [maxJokers, setMaxJokers] = useState(5); 
            const [myJokers, setMyJokers] = useState([]);
            const [consumables, setConsumables] = useState([]); 
            const maxConsumables = 2;
            const [shopJokers, setShopJokers] = useState([]);
            const [scoreBreakdown, setScoreBreakdown] = useState(null);
            const [message, setMessage] = useState('');

            const handleLogin = () => setGameState('menu');
            const startGame = () => setGameState('deck_select');
            
            const launchGame = (chosenDeck) => {
                setSelectedDeck(chosenDeck);
                setDeck(shuffle(createDeck(chosenDeck.type))); 
                setHandStats(DEFAULT_HAND_STATS); 
                setHand([]);
                setRound(1);
                setTargetScore(600);
                setCurrentScore(0);
                setMoney(chosenDeck.stats.money);
                setHandsLeft(chosenDeck.stats.hands);
                setDiscardsLeft(chosenDeck.stats.discards);
                setMaxJokers(chosenDeck.stats.maxJokers);
                let startingJokers = [];
                if (chosenDeck.bonus === 'random_jokers') { for(let i=0; i<2; i++) startingJokers.push({ ...JOKERS_DB[Math.floor(Math.random() * JOKERS_DB.length)], uid: generateUniqueId() }); }
                setMyJokers(startingJokers);
                setConsumables([]);
                setGameState('playing');
                setActionState('idle');
                setMessage('');
            };
            const restartGame = () => { if (selectedDeck) launchGame(selectedDeck); else setGameState('menu'); };

            // Fix: Refilling logic dependency updated and check for deck length
            useEffect(() => {
                if (gameState === 'playing' && hand.length < 10 && deck.length > 0) {
                    const needed = 10 - hand.length;
                    const newCards = deck.slice(0, needed);
                    setHand(prev => [...prev, ...newCards]);
                    setDeck(prev => prev.slice(needed));
                }
            }, [gameState, hand.length, deck.length]); // Added deck.length to dependency

            const toggleSelect = (card) => {
                if (gameState !== 'playing') return; 
                if (card.selected) { setHand(hand.map(c => c.id === card.id ? { ...c, selected: false } : c)); } 
                else {
                    const selectedCount = hand.filter(c => c.selected).length;
                    if (selectedCount >= 5) return; 
                    setHand(hand.map(c => c.id === card.id ? { ...c, selected: true } : c));
                }
            };

            const selectedCards = useMemo(() => hand.filter(c => c.selected), [hand]);
            const currentHandInfo = useMemo(() => {
                const type = detectHandType(selectedCards);
                if (!type) return { name: 'è¯·é€‰ç‰Œ', level: 0, chips: 0, mult: 0 };
                return { type, ...handStats[type] }; 
            }, [selectedCards, handStats]);

            const calculateScore = useCallback((cards, jokers, baseInfo) => {
                if (!baseInfo || baseInfo.chips === undefined) return { totalChips: 0, totalMult: 0, totalScore: 0, triggers: [] };
                let chips = baseInfo.chips;
                let mult = baseInfo.mult;
                let cardChips = 0;
                cards.forEach(c => {
                    let val = c.value;
                    if (c.enhance === 'bonus') val += 30; if (c.enhance === 'stone') val = 50; 
                    cardChips += val;
                    if (c.enhance === 'mult') mult += 4; if (c.enhance === 'glass') mult *= 2; 
                });
                let jokerLog = [];
                jokers.forEach(j => {
                    let triggered = false;
                    if (j.type === 'add_mult') { mult += j.value; triggered = true; } 
                    else if (j.type === 'suit_mult') { if (cards.some(c => c.suit === j.suit || c.enhance === 'wild')) { mult += j.value; triggered = true; } } 
                    else if (j.type === 'rank_mod_mult') { if (cards.some(c => c.value % 2 === j.mod)) { mult += j.value; triggered = true; } }
                    else if (j.type === 'rank_mod_chips') { if (cards.some(c => c.value % 2 === j.mod)) { cardChips += j.value; triggered = true; } }
                    else if (j.type === 'card_specific') { if (cards.some(c => c.rankLabel === j.label)) { chips += j.chips; mult += j.mult; triggered = true; } }
                    else if (j.type === 'count_less') { if (cards.length <= j.count) { mult += j.value; triggered = true; } }
                    else if (j.type === 'discard_bonus') { chips += (discardsLeft * j.value); triggered = true; }
                    if (triggered) jokerLog.push(j.name);
                });
                const steelCards = hand.filter(c => !c.selected && c.enhance === 'steel');
                if (steelCards.length > 0) { steelCards.forEach(() => { mult *= 1.5; }); jokerLog.push(`é’¢é“å¡x${steelCards.length}`); }
                return { totalChips: chips + cardChips, totalMult: mult, totalScore: Math.floor((chips + cardChips) * mult), triggers: jokerLog };
            }, [discardsLeft, hand, selectedDeck]);

            const previewData = useMemo(() => calculateScore(selectedCards, myJokers, currentHandInfo), [selectedCards, myJokers, currentHandInfo, calculateScore]);

            // Explicitly filter unselected cards to keep them
            const playHand = async () => {
                if (selectedCards.length === 0 || handsLeft <= 0) return;
                setActionState('scoring');
                setGameState('scoring');
                const result = previewData;
                setScoreBreakdown({ name: currentHandInfo.name, baseChips: currentHandInfo.chips, cardChips: result.totalChips - currentHandInfo.chips, baseMult: currentHandInfo.mult, finalMult: result.totalMult, total: result.totalScore, jokersTriggered: result.triggers });
                setTimeout(() => {
                    const newScore = currentScore + result.totalScore;
                    setCurrentScore(newScore);
                    setHandsLeft(prev => prev - 1);
                    // Crucial fix: Only remove selected cards, retain others.
                    setHand(prev => prev.filter(c => !c.selected));
                    setScoreBreakdown(null);
                    setActionState('idle'); 
                    if (newScore >= targetScore) { setMessage("ç›®æ ‡è¾¾æˆï¼"); setTimeout(winRound, 1000); } 
                    else if (handsLeft - 1 === 0) { setGameState('gameover'); } 
                    else { setGameState('playing'); }
                }, 2000);
            };

            const discardHand = () => {
                if (selectedCards.length === 0 || discardsLeft <= 0 || actionState !== 'idle') return;
                setActionState('discarding');
                setTimeout(() => { setHand(prev => prev.filter(c => !c.selected)); setDiscardsLeft(prev => prev - 1); setActionState('idle'); }, 500); 
            };

            const winRound = () => {
                const goldCards = hand.filter(c => c.enhance === 'gold');
                const goldMoney = goldCards.length * 3;
                let interestCap = 5;
                if (selectedDeck.id === 'green') interestCap = 0; 
                const interest = Math.min(Math.floor(money / 5), interestCap); 
                let reward = 3 + handsLeft + interest + goldMoney;
                if (selectedDeck.id === 'green') reward += handsLeft * 1; 
                setMoney(prev => prev + reward);
                const shopItems = [];
                for(let i=0; i<5; i++) { 
                    const rand = Math.random();
                    let pool;
                    if (rand < 0.15) pool = PLANETS_DB; else if (rand < 0.3) pool = TAROTS_DB; else if (rand < 0.35) pool = SPECTRAL_DB; else if (rand < 0.45) pool = ENHANCED_CARDS_DB; else pool = JOKERS_DB;
                    shopItems.push({ ...pool[Math.floor(Math.random() * pool.length)], uid: generateUniqueId() });
                }
                setShopJokers(shopItems);
                setGameState('shop');
                setMessage(`å›åˆèƒœåˆ©ï¼è·å¾— $${reward}`);
            };

            const nextRound = () => {
                setRound(r => r + 1);
                setTargetScore(Math.floor(targetScore * 1.8)); 
                setCurrentScore(0);
                setHandsLeft(selectedDeck.stats.hands);
                setDiscardsLeft(selectedDeck.stats.discards);
                setDeck(shuffle(createDeck(selectedDeck.type)));
                setHand([]);
                setGameState('playing');
                setMessage('');
            };

            const buyItem = (item, idx) => {
                if (money >= item.cost) {
                    if (item.type === 'planet' || item.type === 'tarot' || item.type === 'spectral') {
                        if (consumables.length < maxConsumables) {
                            setMoney(m => m - item.cost);
                            setConsumables([...consumables, item]);
                            removeItemFromShop(idx);
                        } else showMessage("æ¶ˆè€—å“æ§½ä½å·²æ»¡ï¼");
                    } else if (item.type === 'playing_card') {
                        setMoney(m => m - item.cost);
                        setDeck(prev => [...prev, {
                            id: generateUniqueId(),
                            suit: item.suit,
                            rankLabel: RANKS.find(r => r.value === (item.rank === 12 ? 11 : item.rank) || r.label === (item.rank === 12 ? 'A' : '')).label, 
                            value: item.rank === 12 ? 11 : item.rank, 
                            rankIndex: item.rank, 
                            selected: false,
                            enhance: item.enhance
                        }]);
                        removeItemFromShop(idx);
                        showMessage("å¡ç‰Œå·²åŠ å…¥ç‰Œç»„");
                    } else {
                        if (myJokers.length < maxJokers) {
                             setMoney(m => m - item.cost);
                             setMyJokers([...myJokers, { ...item, uid: generateUniqueId() }]);
                             removeItemFromShop(idx);
                        } else showMessage("MTæ§½ä½å·²æ»¡ï¼");
                    }
                }
            };

            const removeItemFromShop = (idx) => {
                const newShop = [...shopJokers];
                newShop.splice(idx, 1);
                setShopJokers(newShop);
            };

            const useConsumable = (item) => {
                if (item.type === 'planet') {
                    setHandStats(prev => {
                        const target = item.target;
                        const current = prev[target];
                        return { ...prev, [target]: { ...current, level: current.level + 1, chips: current.chips + item.chipsMod, mult: current.mult + item.multMod } };
                    });
                    showMessage(`å‡çº§æˆåŠŸï¼${item.desc}`);
                } else if (item.effect === 'money') {
                    setMoney(m => Math.min(m + item.amount, m * 2)); 
                    showMessage("è·å¾—é‡‘é’±ï¼");
                } else if (item.effect === 'enhance') {
                    if (selectedCards.length === 0 || selectedCards.length > item.maxCards) { showMessage(`è¯·é€‰æ‹© ${item.maxCards} å¼ ç‰Œä½¿ç”¨`); return; }
                    setHand(prev => prev.map(c => c.selected ? { ...c, enhance: item.enhanceType, selected: false } : c));
                    showMessage("å¡ç‰Œå·²å¢å¼ºï¼");
                } else if (item.effect === 'destroy_hand_money') {
                    if (hand.length < item.count) { showMessage("æ‰‹ç‰Œä¸è¶³ï¼"); return; }
                    let indicesToRemove = [];
                    while(indicesToRemove.length < item.count) {
                        let r = Math.floor(Math.random() * hand.length);
                        if(!indicesToRemove.includes(r)) indicesToRemove.push(r);
                    }
                    setHand(prev => prev.filter((_, i) => !indicesToRemove.includes(i)));
                    setMoney(m => m + item.amount);
                    showMessage("çŒ®ç¥­æˆåŠŸï¼");
                }
                setConsumables(prev => prev.filter(c => c.uid !== item.uid));
            };

            const requestRemoveItem = (item) => setConfirmAction({ item, type: 'remove' });

            const confirmRemoveItem = (item) => {
                if (myJokers.some(j => j.uid === item.uid)) {
                    setMoney(m => m + Math.floor(item.cost / 2));
                    setMyJokers(prev => prev.filter(j => j.uid !== item.uid));
                } else if (consumables.some(c => c.uid === item.uid)) {
                    setMoney(m => m + Math.floor(item.cost / 2));
                    setConsumables(prev => prev.filter(c => c.uid !== item.uid));
                }
                setConfirmAction(null);
            };

            const showMessage = (msg) => { setMessage(msg); setTimeout(() => setMessage(''), 1500); };

            const shopJokersList = useMemo(() => shopJokers.filter(item => item.type === 'add_mult' || item.type.includes('mult') || item.type.includes('chips') || item.type === 'card_specific' || item.type === 'discard_bonus' || item.type === 'count_less'), [shopJokers]);
            const shopOthersList = useMemo(() => shopJokers.filter(item => !shopJokersList.includes(item)), [shopJokers, shopJokersList]);

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 font-sans selection:bg-blue-500 selection:text-white flex flex-col items-center justify-start p-2 sm:p-4 overflow-y-auto">
                {gameState === 'login' && <LoginScreen onLogin={handleLogin} />}
                {gameState !== 'login' && (
                    <>
                        {showSettings && <SettingsModal onClose={() => setShowSettings(false)} onRestart={restartGame} onMenu={() => setGameState('menu')} />}
                        {showRunInfo && <RunInfoModal handStats={handStats} onClose={() => setShowRunInfo(false)} />}
                        {showDeckView && <DeckViewModal deck={deck} onClose={() => setShowDeckView(false)} />}
                        {confirmAction && <ConfirmModal item={confirmAction.item} onConfirm={confirmRemoveItem} onCancel={() => setConfirmAction(null)} />}

                        {/* Top Bar */}
                        {gameState !== 'menu' && gameState !== 'deck_select' && (
                            <div className="w-full max-w-4xl bg-slate-800 p-3 rounded-xl shadow-lg border border-slate-700 z-10 relative mb-2 flex flex-col gap-3">
                                <div className="flex justify-between items-center border-b border-slate-700 pb-2">
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowSettings(true)} className="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-md flex items-center gap-1.5 transition-transform active:scale-95"><Settings size={16}/> è®¾ç½®</button>
                                        <button onClick={() => setShowRunInfo(true)} className="bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-md flex items-center gap-1.5 transition-transform active:scale-95"><BarChart3 size={16}/> æ¯”èµ›ä¿¡æ¯</button>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => setShowDeckView(true)} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-md flex items-center gap-1.5 transition-transform active:scale-95"><Eye size={16}/> æŸ¥çœ‹ç‰Œç»„</button>
                                        <span className="text-xs text-slate-400">åº•æ³¨ç­‰çº§</span><span className="text-lg font-bold text-orange-400 bg-orange-900/30 px-2 rounded border border-orange-500/30">#{round}</span>
                                    </div>
                                </div>
                                <div className="flex justify-between items-end relative">
                                    <div className="flex flex-col"><span className="text-[10px] sm:text-xs text-slate-400 uppercase tracking-wider">æœ¬è½®åˆ†æ•°</span><div className="text-2xl sm:text-3xl font-bold font-mono tracking-tighter leading-none">{Math.floor(currentScore).toLocaleString()} <span className="text-sm text-slate-500 mx-1">/</span> <span className="text-lg sm:text-xl text-red-400">{Math.floor(targetScore).toLocaleString()}</span></div></div>
                                    
                                    <div className={`transition-all duration-300 transform origin-right ${selectedCards.length > 0 ? 'w-auto opacity-100 translate-x-0' : 'w-0 opacity-0 translate-x-4 overflow-hidden'}`}>
                                        <div className="bg-slate-900 border-2 border-indigo-500 rounded-lg shadow-[0_0_15px_rgba(99,102,241,0.4)] px-3 py-1 flex flex-col items-center justify-center min-w-[100px] whitespace-nowrap mr-2">
                                            <div className="text-[10px] text-indigo-300 font-bold uppercase tracking-wider mb-0.5 text-center">{currentHandInfo.name} <span className="text-indigo-500">Lv.{currentHandInfo.level}</span></div>
                                            <div className="flex items-center gap-1.5 font-mono leading-none">
                                                <span className="text-blue-400 font-bold text-lg">{previewData.totalChips}</span><span className="text-[10px] text-slate-500">X</span><span className="text-red-400 font-bold text-lg">{previewData.totalMult}</span>
                                            </div>
                                        </div>
                                     </div>

                                    <div className="flex items-center gap-3 sm:gap-6"><div className="flex flex-col items-center"><span className="text-[10px] text-blue-300">å‡ºç‰Œ</span><span className="text-lg sm:text-xl font-bold text-blue-400">{handsLeft}</span></div><div className="flex flex-col items-center"><span className="text-[10px] text-red-300">å¼ƒç‰Œ</span><span className="text-lg sm:text-xl font-bold text-red-400">{discardsLeft}</span></div><div className="flex flex-col items-center bg-yellow-900/30 px-3 py-1 rounded-lg border border-yellow-700/50 min-w-[60px]"><span className="text-[10px] text-yellow-500 flex items-center gap-1"><ShoppingBag size={10}/> é‡‘é’±</span><span className="text-lg sm:text-xl font-bold text-yellow-400">${money}</span></div></div>
                                </div>
                                <div className="absolute bottom-0 left-0 w-full h-1 bg-slate-700/50 rounded-b-xl overflow-hidden">
                                    <div className="h-full bg-gradient-to-r from-blue-500 to-red-500 transition-all duration-500 ease-out" style={{ width: `${Math.min((currentScore / targetScore) * 100, 100)}%` }} />
                                </div>
                            </div>
                        )}

                        {/* MT æ§½ä½ç­‰ */}
                        {gameState !== 'menu' && gameState !== 'deck_select' && (
                            <div className="w-full max-w-4xl flex gap-2 mb-2">
                                <div className="flex-1 h-28 sm:h-32 flex items-center justify-start gap-2 p-2 rounded-xl border-2 border-dashed border-slate-700/50 bg-slate-800/50 overflow-x-auto hide-scrollbar">
                                    {myJokers.length === 0 && <span className="text-slate-600 text-sm w-full text-center">æš‚æ— MT <br/> <span className="text-xs">ä¸Šé™: {maxJokers}</span></span>}
                                    {myJokers.map((joker) => <JokerCard key={joker.uid} joker={joker} onSell={requestRemoveItem} />)}
                                </div>
                                <div className="w-1/3 h-28 sm:h-32 flex items-center justify-start gap-2 p-2 rounded-xl border-2 border-dashed border-blue-900/50 bg-slate-800/50 overflow-x-auto hide-scrollbar">
                                    {consumables.length === 0 && <span className="text-slate-600 text-sm w-full text-center">æ¶ˆè€—å“ <br/> <span className="text-xs">{consumables.length}/{maxConsumables}</span></span>}
                                    {consumables.map((item) => (<div key={item.uid} className="relative group"><JokerCard joker={item} onSell={requestRemoveItem} /><button onClick={() => useConsumable(item)} className="absolute bottom-0 left-0 w-full bg-blue-600 text-[10px] font-bold text-white opacity-0 group-hover:opacity-100 transition-opacity">ä½¿ç”¨</button></div>))}
                                </div>
                            </div>
                        )}

                        <div className="relative w-full max-w-5xl flex-1 flex flex-col items-center justify-center min-h-[350px] sm:min-h-[400px]">
                            {gameState === 'scoring' && scoreBreakdown && (
                                <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/85 backdrop-blur-sm rounded-xl animate-in fade-in zoom-in duration-300 p-4">
                                    <div className="text-3xl sm:text-4xl font-bold text-white mb-2">{scoreBreakdown.name}</div>
                                    <div className="flex items-center gap-2 sm:gap-4 text-xl sm:text-2xl font-mono mb-6"><div className="bg-blue-600 px-3 py-1 rounded-lg text-white">{scoreBreakdown.baseChips + scoreBreakdown.cardChips}</div><XCircle size={20} className="text-slate-400"/><div className="bg-red-600 px-3 py-1 rounded-lg text-white">{scoreBreakdown.finalMult}</div></div>
                                    <div className="text-5xl sm:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-sm mb-4">{scoreBreakdown.total}</div>
                                    {scoreBreakdown.jokersTriggered.length > 0 && <div className="text-xs sm:text-sm text-yellow-200/80 mt-2 text-center">è§¦å‘: {scoreBreakdown.jokersTriggered.join(', ')}</div>}
                                </div>
                            )}

                            {gameState === 'menu' && (
                                <div className="absolute inset-0 z-40 flex flex-col items-center justify-center bg-slate-900/95 rounded-xl text-center px-4">
                                    <CapybaraAvatar />
                                    <h1 className="text-3xl sm:text-4xl font-black text-white mb-2 tracking-tighter">MTTTTTå¡ç‰Œ</h1>
                                    <p className="text-slate-400 mb-8 text-sm">ç‚¹å‡»ä¸‹æ–¹å¼€å§‹ä½ çš„å¡ç‰Œä¹‹æ—…</p>
                                    <button onClick={startGame} className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-12 rounded-full text-xl shadow-lg transition-all transform hover:scale-105 active:scale-95 flex items-center gap-2">
                                        <Play fill="currentColor" /> å¼€å§‹æ¸¸æˆ
                                    </button>
                                </div>
                            )}

                            {gameState === 'deck_select' && (
                                <div className="absolute inset-0 z-40 flex flex-col items-center bg-slate-900 p-4 overflow-y-auto">
                                    <h2 className="text-3xl font-bold text-white mb-6 mt-4 flex items-center gap-2"><Layers/> é€‰æ‹©ä½ çš„å¡ç»„</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-5xl pb-8">{DECKS.map((deck) => (<div key={deck.id} onClick={() => launchGame(deck)} className={`relative cursor-pointer group overflow-hidden rounded-xl border-2 p-6 transition-all duration-300 hover:scale-[1.02] active:scale-95 bg-gradient-to-br shadow-xl ${deck.color}`}><div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Layers size={100} /></div><h3 className="text-2xl font-bold text-white mb-2 relative z-10">{deck.name}</h3><p className="text-white/90 text-sm mb-4 min-h-[40px] relative z-10">{deck.desc}</p><div className="flex flex-wrap gap-2 relative z-10"><span className="bg-black/30 px-2 py-1 rounded text-xs font-mono text-blue-200">å‡ºç‰Œ: {deck.stats.hands}</span><span className="bg-black/30 px-2 py-1 rounded text-xs font-mono text-red-200">å¼ƒç‰Œ: {deck.stats.discards}</span><span className="bg-black/30 px-2 py-1 rounded text-xs font-mono text-yellow-200">é‡‘é’±: ${deck.stats.money}</span><span className="bg-black/30 px-2 py-1 rounded text-xs font-mono text-purple-200">MTæ§½: {deck.stats.maxJokers}</span></div></div>))}</div>
                                    <button onClick={() => setGameState('menu')} className="mt-auto mb-8 text-slate-400 hover:text-white flex items-center gap-2"><RotateCcw size={16}/> è¿”å›ä¸»èœå•</button>
                                </div>
                            )}

                            {gameState === 'gameover' && (
                                <div className="absolute inset-0 z-40 flex flex-col items-center justify-center bg-black/95 rounded-xl">
                                    <h1 className="text-5xl font-bold text-red-500 mb-4">æ¸¸æˆç»“æŸ</h1><p className="text-slate-300 mb-6">æœ€ç»ˆå›åˆ: {round} - åˆ†æ•°: {currentScore}</p><button onClick={() => setGameState('menu')} className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-lg transition-all active:scale-95"><RotateCcw size={18}/> è¿”å›èœå•</button>
                                </div>
                            )}

                            {gameState === 'shop' && (
                                <div className="absolute inset-0 z-40 flex flex-col items-center bg-slate-800 rounded-xl p-4 sm:p-6 border-4 border-yellow-600/30 overflow-y-auto">
                                    <div className="flex justify-between w-full items-center mb-6 border-b border-slate-700 pb-4 sticky top-0 bg-slate-800 z-10"><h2 className="text-2xl sm:text-3xl font-bold text-yellow-500 flex items-center gap-2"><ShoppingBag/> å•†åº—</h2><div className="text-lg sm:text-xl font-mono bg-slate-900 px-4 py-1 rounded text-yellow-400">æ‹¥æœ‰: ${money}</div></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl flex-1">
                                        <div className="flex flex-col gap-4">
                                            <div className="text-slate-400 font-bold uppercase tracking-wider text-sm border-b border-slate-700 pb-2">é“å…·åŒº (MTç‰Œ)</div>
                                            <div className="flex flex-wrap gap-4">{shopJokersList.length > 0 ? shopJokersList.map((item, idx) => (<div key={item.uid} className="flex flex-col gap-2 items-center bg-slate-700/30 p-2 rounded-lg"><JokerCard joker={item} /><button onClick={() => buyItem(item, 0)} disabled={money < item.cost} className={`w-full py-2 rounded text-sm font-bold shadow-md active:scale-95 transition-transform ${money >= item.cost ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>${item.cost} è´­ä¹°</button></div>)) : <div className="text-slate-600 italic p-4">æœ¬è½®æ— é“å…·å‡ºå”®</div>}</div>
                                        </div>
                                        <div className="flex flex-col gap-4">
                                            <div className="text-slate-400 font-bold uppercase tracking-wider text-sm border-b border-slate-700 pb-2">è¡¥ç»™åŒº (æ˜Ÿçƒ/å¡”ç½—/å¹»çµ/å¡ç‰Œ)</div>
                                            <div className="flex flex-wrap gap-4">{shopOthersList.length > 0 ? shopOthersList.map((item, idx) => (<div key={item.uid} className="flex flex-col gap-2 items-center bg-slate-700/30 p-2 rounded-lg"><JokerCard joker={item} /><button onClick={() => buyItem(item, 0)} disabled={money < item.cost} className={`w-full py-2 rounded text-sm font-bold shadow-md active:scale-95 transition-transform ${money >= item.cost ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>${item.cost} è´­ä¹°</button></div>)) : <div className="text-slate-600 italic p-4">æœ¬è½®æ— è¡¥ç»™å“å‡ºå”®</div>}</div>
                                        </div>
                                    </div>
                                    <button onClick={nextRound} className="mt-8 bg-red-600 hover:bg-red-500 active:bg-red-700 text-white font-bold py-4 px-12 rounded-xl text-xl shadow-lg transition-all flex items-center gap-2 w-full sm:w-auto justify-center">ä¸‹ä¸€å›åˆ <Play size={24} fill="currentColor"/></button>
                                </div>
                            )}

                            {(gameState === 'playing' || gameState === 'scoring') && (
                                <>
                                    <div className="grid grid-cols-5 gap-2 px-2 pb-4 pt-4 w-full max-w-lg mx-auto">
                                        {hand.map((card) => <Card key={card.id} card={card} onClick={toggleSelect} animationState={actionState} />)}
                                    </div>
                                    <div className="mt-auto sm:mt-8 w-full flex gap-3 px-2 pb-2">
                                        <button onClick={playHand} disabled={selectedCards.length === 0 || gameState === 'scoring'} className={`flex-1 py-4 rounded-xl font-bold text-lg shadow-lg transition-all transform active:scale-95 ${selectedCards.length > 0 ? 'bg-orange-500 text-white shadow-orange-500/30' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>å‡ºç‰Œ</button>
                                        <button onClick={discardHand} disabled={selectedCards.length === 0 || discardsLeft <= 0 || gameState === 'scoring'} className={`flex-1 py-4 rounded-xl font-bold text-lg border-2 transition-all active:scale-95 ${selectedCards.length > 0 && discardsLeft > 0 ? 'border-red-500 text-red-400 bg-red-500/10' : 'border-slate-700 text-slate-600 cursor-not-allowed'}`}>å¼ƒç‰Œ</button>
                                    </div>
                                    <div className="mt-4 mb-4 flex gap-4 w-full px-2">
                                        <button onClick={() => setHand(prev => [...prev].sort((a,b) => b.rankIndex - a.rankIndex))} className="flex-1 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 text-slate-300 py-3 rounded-xl font-bold text-sm sm:text-base border border-slate-600 shadow-md transition-colors">æŒ‰ç‚¹æ•°æ’åº</button>
                                        <button onClick={() => setHand(prev => [...prev].sort((a,b) => a.suit.localeCompare(b.suit)))} className="flex-1 bg-slate-800 hover:bg-slate-700 active:bg-slate-600 text-slate-300 py-3 rounded-xl font-bold text-sm sm:text-base border border-slate-600 shadow-md transition-colors">æŒ‰èŠ±è‰²æ’åº</button>
                                    </div>
                                </>
                            )}
                        </div>
                    </>
                )}
                {message && <div className="fixed top-24 left-1/2 -translate-x-1/2 bg-yellow-500 text-black px-8 py-4 rounded-xl font-bold shadow-2xl animate-bounce z-[60] text-xl border-4 border-white whitespace-nowrap">{message}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>